<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Atlas - Performance Dashboard (DEMO)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,400;0,6..12,600;0,6..12,700;1,6..12,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@4.1.0/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

    <style>
        /* --- CORE STYLES: Project Atlas Theme --- */
        :root {
            /* Light Mode Theme */
            --atlas-gold: #B48F4C;
            --atlas-dark-blue: #002A42;
            --atlas-text-primary: #1d2125;
            --atlas-text-secondary: #5a6167;
            --atlas-bg-primary: #F4F6F8;
            --atlas-bg-secondary: #FFFFFF;
            --atlas-border-color: #DEE2E6;
            --atlas-shadow-color: rgba(0,0,0,0.05);
            --animation-speed: 0.3s;
			--atlas-accent-color: #B48F4C;
			--atlas-gray-600: #5a6167;
			--atlas-border-color-light: #E9ECEF;
        }

        [data-theme="dark"] {
            /* Dark Mode Theme - Inspired by your image */
            --atlas-gold: #D4AF37;
            --atlas-dark-blue: #EAEAEA;
            --atlas-text-primary: #EAEAEA;
            --atlas-text-secondary: #9BA3AE;
            --atlas-bg-primary: #1A1D21; /* Deep charcoal, like the dark parts of the forest */
            --atlas-bg-secondary: #24282E; /* Panel background */
            --atlas-border-color: #3A414A;
            --atlas-shadow-color: rgba(0,0,0,0.2);
			--atlas-accent-color: #D4AF37; /* Incremental Revenue (Gold) */
			--atlas-gray-600: #5a6167;     /* Baseline Revenue (Gray) */
			--atlas-border-color-light: #3A414A; /* Consistent border color */
        }

        html, body {
            height: 100%; margin: 0; font-family: 'Nunito Sans', sans-serif;
            background-color: var(--atlas-bg-primary); color: var(--atlas-text-primary);
            line-height: 1.6; overflow: hidden; transition: background-color var(--animation-speed);
        }

        .app-layout { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            background-color: var(--atlas-bg-secondary); border-right: 1px solid var(--atlas-border-color);
            display: flex; flex-direction: column; padding: 25px;
            transition: all var(--animation-speed);
        }
        .sidebar-header { text-align: left; margin-bottom: 40px; }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container svg { height: 45px; width: auto; }
        .logo-container .logo-text { font-size: 1.2em; font-weight: 700; color: var(--atlas-text-primary); line-height: 1.1; }
        .logo-container .logo-text span { font-size: 0.8em; font-weight: 400; color: var(--atlas-text-secondary); }

        nav ul { list-style: none; padding: 0; margin: 0; }
        nav a {
            display: flex; align-items: center; padding: 13px 18px; text-decoration: none;
            color: var(--atlas-text-secondary); border-radius: 8px; font-weight: 600;
            margin-bottom: 8px; transition: all 0.2s ease;
        }
        nav a:hover { background-color: var(--atlas-bg-primary); color: var(--atlas-text-primary); }
        nav a.active {
            background-color: var(--atlas-gold); color: #1A1D21; font-weight: 700;
            box-shadow: 0 4px 15px -5px var(--atlas-gold);
        }
        nav a.active svg { stroke: #1A1D21; }
        nav svg { margin-right: 15px; stroke-width: 2; width: 22px; height: 22px; transition: stroke 0.2s; }
        .sidebar-footer { margin-top: auto; }
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 8px; background-color: var(--atlas-bg-primary);}
        .theme-switch { display: inline-block; height: 22px; position: relative; width: 42px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 22px; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--atlas-gold); }
        input:checked + .slider:before { transform: translateX(19px); }

        /* --- MAIN CONTENT --- */
        .main-content { padding: 40px 50px; overflow-y: auto; }
        /* The .page-content wrapper is now loaded from the template */
        .page-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { margin-bottom: 35px; }
        .page-header h1 { color: var(--atlas-text-primary); font-size: 2.8em; margin: 0; font-weight: 700; }
        .page-header p { color: var(--atlas-text-secondary); font-size: 1.2em; margin: 5px 0 0; }
        
        .panel {
            background-color: var(--atlas-bg-secondary); padding: 30px; margin-bottom: 25px;
            border-radius: 12px; border: 1px solid var(--atlas-border-color);
            box-shadow: 0 5px 25px var(--atlas-shadow-color);
            transition: all var(--animation-speed);
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--atlas-border-color); }
        .panel-header h2 { color: var(--atlas-text-primary); margin: 0; font-size: 1.6em; }
        .panel-header h2 small { color: var(--atlas-text-secondary); font-size: 0.7em; font-weight: 400; display: block; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; }
        .kpi-card { background: var(--atlas-bg-primary); padding: 25px; border-radius: 8px; border-left: 4px solid var(--atlas-gold); }
        .kpi-card .label { font-size: 1em; font-weight: 600; color: var(--atlas-text-secondary); margin-bottom: 8px; }
        .kpi-card .value { font-size: 2.5em; font-weight: 700; line-height: 1.2; color: var(--atlas-text-primary); }
        .kpi-card .change { font-size: 0.9em; font-weight: 600; }
        .change.positive { color: #28a745; }
        .change.negative { color: #dc3545; }
        
        .chart-container { position: relative; height: 380px; width: 100%; }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--atlas-text-primary); }
        select, input[type="text"], input[type="date"] {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--atlas-border-color);
            border-radius: 6px; background-color: var(--atlas-bg-primary); color: var(--atlas-text-primary);
            font-size: 1em; transition: border-color 0.2s; box-sizing: border-box;
        }
        select:focus, input:focus { outline: none; border-color: var(--atlas-gold); }
        .filter-bar { display: flex; gap: 20px; align-items: center; }
        
        button {
            background-color: var(--atlas-gold); color: #1A1D21; padding: 12px 28px; border: 1px solid var(--atlas-gold);
            border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 700;
            transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        button svg { margin-right: 8px; }
        
        /* --- Budget Simulator Specific Styles --- */
        .simulator-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px 25px; align-items: center; margin-bottom: 15px; }
        .simulator-grid label { margin-bottom: 0; font-weight: 600; }
        input[type="range"] { width: 100%; margin: 0; accent-color: var(--atlas-gold); }
        .budget-value { font-weight: 700; font-size: 1.1em; color: var(--atlas-text-primary); }
		
		.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
		.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }

		.recommendation-card {
			background-color: var(--atlas-gold-light, #f7f1e6); /* Added fallback for light mode */
			border: 1px solid var(--atlas-gold);
			padding: 20px;
			border-radius: 8px;
			display: flex;
			align-items: flex-start;
			gap: 15px;
		}
		[data-theme="dark"] .recommendation-card {
			background-color: #3a321e; /* Specific dark mode color from Sample 2 */
		}
		.recommendation-card .icon {
			color: var(--atlas-gold);
			flex-shrink: 0;
		}
		.recommendation-card h3 {
			margin: 0 0 5px 0;
			font-size: 1.1em;
		}
		.recommendation-card p {
			margin: 0;
			font-size: 0.95em;
			color: var(--atlas-text-secondary);
		}

		.driver-list {
			list-style: none;
			padding: 0;
			margin: 0;
		}
		.driver-list li {
			display: flex;
			align-items: center;
			font-weight: 600;
			margin-bottom: 12px;
		}
		.driver-list .icon {
			width: 20px;
			height: 20px;
			margin-right: 10px;
		}
		.driver-list .positive .icon {
			color: #28a745; /* Using color from wireframe */
		}
		.driver-list .negative .icon {
			color: #dc3545; /* Using color from wireframe */
		}

        /* --- Shapley Value Analysis Page Specific Styles (FIXED) --- */
        .waterfall-chart {
            display: flex;
            justify-content: space-around;
            height: 350px; /* Overall container height */
            width: 100%;
            border-bottom: 2px solid var(--atlas-border-color);
            padding: 0 20px;
            box-sizing: border-box;
        }

        .waterfall-item {
            position: relative; /* KEY FIX: Each column is now a positioning context. */
            flex: 1; /* Distribute space evenly */
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Pushes the label to the bottom */
        }

        .waterfall-label {
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--atlas-text-secondary);
            padding-bottom: 10px; /* Space between text and bottom border */
        }

        .waterfall-bar {
            position: absolute; /* Positioned absolutely within .waterfall-item */
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            transition: all 0.5s ease-out;
            /* `bottom` and `height` will be set via inline styles */
        }

        .waterfall-value {
            position: absolute; /* Positioned absolutely within .waterfall-item */
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.9em;
            font-weight: 700;
            color: var(--atlas-text-primary);
            /* `bottom` will be set via inline style to be just above its bar */
        }

        .waterfall-bar.base, .waterfall-bar.total {
            background-color: var(--atlas-text-secondary);
        }
        .waterfall-bar.positive {
            background-color: #28a745;
            border-radius: 4px 4px 0 0;
        }
        .waterfall-bar.negative {
            background-color: #dc3545;
            border-radius: 0 0 4px 4px;
        }

        /* Connector Lines */
        .waterfall-item .connector {
            position: absolute;
            left: 50%;
            width: 100%; /* Will span the gap between columns */
            border-top: 2px dashed var(--atlas-border-color);
            /* `bottom` for positioning is set via inline style */
        }

        /* Hide the last connector line */
        .waterfall-item:last-child .connector {
            display: none;
        }

        /* Drill-Down Section - Switched to simple text list */
        .drilldown-text-list {
            display: flex;
            flex-direction: column;
            gap: 18px; /* Creates space between each item */
        }
        .drilldown-text-item .label {
            font-weight: 600;
            color: var(--atlas-text-primary);
            font-size: 1em;
            line-height: 1.3;
        }
        .drilldown-text-item .value {
            color: var(--atlas-text-secondary);
            font-size: 0.95em;
            font-weight: 600;
        }
		#incrementality-chart-area > div {
			height: 100%;
		}
		
        .filters-container { display: flex; gap: 20px; margin-bottom: 35px; align-items: center; flex-wrap: wrap; }
.filter-group { display: flex; flex-direction: column; }
.filter-group label { font-size: 0.9em; font-weight: 600; color: var(--atlas-text-secondary); margin-bottom: 5px; }
.filter-group select, .filter-group input[type="date"] {
    padding: 8px 12px; border-radius: 6px; border: 1px solid var(--atlas-border-color);
    background-color: var(--atlas-bg-secondary); color: var(--atlas-text-primary);
    font-family: 'Nunito Sans', sans-serif; font-size: 1em;
    height: 41px; box-sizing: border-box;
}
.filter-group select { min-width: 150px; }

.grid-5 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }

.snapshot-group { margin-bottom: 25px; }
.snapshot-group:last-child { margin-bottom: 0; }
.snapshot-group-title { font-size: 1.1em; font-weight: 700; color: var(--atlas-text-primary); margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--atlas-border-color); }
.snapshot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }

.snapshot-card { text-align: center; background: var(--atlas-bg-primary); padding: 20px; border-radius: 8px; }
.snapshot-card .label { font-size: 0.85em; font-weight: 600; color: var(--atlas-text-secondary); margin-bottom: 8px; text-transform: uppercase; }
.snapshot-card .value { font-size: 1.8em; font-weight: 700; color: var(--atlas-text-primary); }
.snapshot-card .change { margin-top: 5px; }
.loading-overlay { display: none; text-align: center; padding: 40px; color: var(--atlas-text-secondary); }

.toggle-recs-button {
    background: none; border: none; cursor: pointer; padding: 0;
    font-family: inherit; font-weight: 600; color: var(--atlas-gold); 
    text-decoration: none; font-size: 0.9em;
}
.toggle-recs-button:hover { text-decoration: underline; }
    

/* --- Advanced Budget Simulator Specific Styles --- */
.simulator-grid { 
    display: grid; 
    grid-template-columns: 1.5fr 2fr 1fr; /* MODIFIED: Adjusted column ratio */
    gap: 15px 25px; 
    align-items: center; 
    margin-bottom: 15px; 
}
.budget-value-wrapper { display: flex; align-items: center; justify-content: flex-start; }
.warning-icon { 
    display: none;
    margin-left: 8px;
    color: var(--atlas-warning-color, #f39c12);
    cursor: help;
    font-size: 1.2em;
}
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px 25px;
    align-items: end;
}
.config-item { display: flex; flex-direction: column; }
#date-range-group-wrapper { grid-column: span 2; min-width: 320px; }
.date-input-container { display: flex; align-items: center; gap: 10px; }
.date-input-container input { flex-grow: 1; }
.date-separator { color: var(--atlas-text-secondary); font-weight: 600; }
#channel-select-wrapper { grid-column: 1 / -1; }
.config-grid label {
    margin-bottom: 6px;
    font-size: 0.9em;
    color: var(--atlas-text-secondary);
}
.kpi-value {
    font-size: 2.2em;
    font-weight: 700;
    color: var(--atlas-gold);
    line-height: 1;
    padding-bottom: 7px;
}
.multi-select-container { position: relative; width: 100%; }
.multi-select-display {
    background-color: var(--atlas-bg-primary); border: 1px solid var(--atlas-border-color);
    border-radius: 6px; padding: 8px 12px; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center; user-select: none;
}
.multi-select-display:after {
    content: ''; border: solid var(--atlas-text-secondary); border-width: 0 2px 2px 0;
    display: inline-block; padding: 3px; transform: rotate(45deg); transition: transform 0.2s;
}
.multi-select-container.open .multi-select-display:after { transform: rotate(-135deg); }
.multi-select-dropdown {
    display: none; position: absolute; top: 100%; left: 0; right: 0;
    background-color: var(--atlas-bg-secondary); border: 1px solid var(--atlas-border-color);
    border-radius: 6px; margin-top: 4px; max-height: 200px; overflow-y: auto;
    z-index: 10; box-shadow: 0 5px 15px var(--atlas-shadow-color);
}
.multi-select-container.open .multi-select-dropdown { display: block; }
.multi-select-dropdown .item { display: block; padding: 8px 12px; cursor: pointer; }
.multi-select-dropdown .item:hover { background-color: var(--atlas-bg-primary); }
.multi-select-dropdown .item input[type="checkbox"] { margin-right: 10px; width: auto; accent-color: var(--atlas-gold); }
.panel-advanced {
    position: relative;
    background: radial-gradient(circle at 50% 0%, hsl(from var(--atlas-bg-secondary) h s l+4%) 0%, var(--atlas-bg-secondary) 70%);
    border: 1px solid transparent;
    border-image: linear-gradient(to bottom right, var(--atlas-gold), #4a5a6a) 1;
}
.panel-advanced .panel-header h2 small { color: var(--atlas-gold); opacity: 0.9; font-weight: 600; }
.optimizer-grid { display: grid; grid-template-columns: 2fr 2fr 1.2fr; gap: 20px; align-items: flex-end; }
.atlas-button {
    background-color: var(--atlas-gold); color: #fff; border: none; padding: 10px 15px;
    border-radius: 6px; font-family: inherit; font-weight: 700; font-size: 1em; cursor: pointer;
    transition: all 0.3s; width: 100%;
}
.atlas-button:hover:not(:disabled) { opacity: 0.85; }
.atlas-button:disabled { background-color: var(--atlas-text-secondary); cursor: not-allowed; }
.progress-bar-container { width: 100%; background-color: var(--atlas-bg-primary); border-radius: 4px; overflow: hidden; height: 8px; border: 1px solid var(--atlas-border-color); }
.progress-bar-inner { width: 0%; height: 100%; background-color: var(--atlas-gold); border-radius: 4px; transition: width 0.2s ease-out; }
.viz-block { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--atlas-border-color); }
.viz-toolbar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
.viz-toolbar label { margin-bottom: 0; }
.viz-toolbar select { width: auto; min-width: 250px; }
.viz-toolbar #viz-efficiency { font-size: 0.9em; color: var(--atlas-text-secondary); }
#viz-canvas-wrap { position: relative; height: 340px; }
#viz-canvas { display: block; width: 100% !important; height: 100% !important; }
.info-helper { position: relative; display: inline-block; margin-left: 8px; vertical-align: middle; }
.info-icon {
    display: flex; justify-content: center; align-items: center; width: 16px; height: 16px; border-radius: 50%;
    border: 1px solid var(--atlas-text-secondary); color: var(--atlas-text-secondary); font-size: 11px;
    font-weight: 700; cursor: help; transition: all 0.3s;
}
.info-helper:hover .info-icon { background-color: var(--atlas-gold); color: var(--atlas-bg-secondary); border-color: var(--atlas-gold); }
.info-tooltip {
    visibility: hidden; opacity: 0; width: 280px; background-color: var(--atlas-bg-secondary); color: var(--atlas-text-primary);
    text-align: left; border-radius: 8px; padding: 12px 15px; position: absolute; z-index: 100;
    bottom: 125%; left: 50%; margin-left: -140px; transition: opacity 0.3s, visibility 0.3s;
    box-shadow: 0 4px 15px var(--atlas-shadow-color); border: 1px solid var(--atlas-border-color);
    font-size: 0.9rem; font-weight: 400; line-height: 1.5;
}
.info-tooltip::after {
    content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
    border-width: 5px; border-style: solid; border-color: var(--atlas-border-color) transparent transparent transparent;
}
.info-helper:hover .info-tooltip { visibility: visible; opacity: 1; }
@media (max-width: 768px) {
    #date-range-group-wrapper { grid-column: auto; min-width: 0; }
}
@media (max-width: 600px) {
    .optimizer-grid { grid-template-columns: 1fr; }
}

    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div>
                <div class="sidebar-header">
                    <div class="logo-container">
                        <!-- Self-contained SVG Logo inspired by your design -->
                        <svg viewBox="0 0 100 100" fill="var(--atlas-gold)" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 0L0 90H15L50 20L85 90H100L50 0Z"/>
                            <path d="M50 55C63.8071 55 75 43.8071 75 30C75 16.1929 63.8071 5 50 5C36.1929 5 25 16.1929 25 30C25 43.8071 36.1929 55 50 55Z" fill-opacity="0.1"/>
                            <path d="M50 98C76.5097 98 98 76.5097 98 50C98 23.4903 76.5097 2 50 2C23.4903 2 2 23.4903 2 50C2 76.5097 23.4903 98 50 98Z" stroke="var(--atlas-gold)" stroke-width="3" fill="none" stroke-opacity="0.5"/>
                        </svg>
                        <div class="logo-text">
                            Atlas Platforms
                            <span>Performance Dashboard</span>
                        </div>
                    </div>
                </div>
                <nav id="main-nav">
                    <ul>
						<li><a href="#" class="active" data-target="page-command-center">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21M9 17.25v-10.5a3.375 3.375 0 013.375-3.375h1.5A3.375 3.375 0 0117.25 6.75v10.5a3.375 3.375 0 01-3.375 3.375h-1.5A3.375 3.375 0 019 17.25z" /></svg>
							Command Centre
						</a></li>
						<li><a href="#" data-target="page-dashboard">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
							Dashboard
						</a></li>
                        <li><a href="#" data-target="page-deep-dive">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                           Channel Deep Dive
                        </a></li>
                        <li><a href="#" data-target="page-simulator">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                           Budget Simulator
                        </a></li>
                        <li><a href="#" data-target="page-shapley-analysis">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM12 15.75a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM16.783 10.907a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM12 6.75a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM4.5 15.75a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM4.5 6.75a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM19.5 15.75a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM19.5 6.75a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186zM12 1.5a2.25 2.25 0 100 4.186 2.25 2.25 0 000-4.186z"></path></svg>
							Shapley Analysis
						</a></li>
                        <li><a href="#" data-target="page-granular-reporting">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5l6.75-6.75 4.5 4.5L21 4.5" /></svg>
							Granular Performance
						</a></li>
						<li><a href="#" data-target="page-incrementality">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
							Incrementality
						</a></li>
						<li><a href="#" data-target="page-funnel">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
							Funnel Breakdown
						</a></li>
						<li><a href="#" data-target="page-next-best-move">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.594-.484-1.078-1.078-1.078h-1.094c-.594 0-1.078.484-1.078 1.078v7.511c0 .594.484 1.078 1.078 1.078h1.094c.594 0 1.078-.484 1.078-1.078V6.087z" /><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087a3.375 3.375 0 013.375 3.375v1.5c0 1.86-1.515 3.375-3.375 3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5c0-.621.504-1.125 1.125-1.125h1.5zM9.75 15.75c0 .594.484 1.078 1.078 1.078h1.094c.594 0 1.078-.484 1.078-1.078v-7.511c0-.594-.484-1.078-1.078-1.078H10.828c-.594 0-1.078.484-1.078 1.078v7.511z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 15.75a3.375 3.375 0 00-3.375-3.375v-1.5c0-1.86 1.515-3.375 3.375-3.375h1.5c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125h-1.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 10.5a13.435 13.435 0 011.378-5.624m15.244 0A13.435 13.435 0 0121 10.5m-18 0a13.435 13.435 0 001.378 5.624m15.244 0A13.435 13.435 0 0021 10.5m-18 0h18" /></svg>
							Optimal Plays
						</a></li>
						<li><a href="#" data-target="page-anomaly-radar">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
							Anomaly Radar
						</a></li>
                    </ul>
                </nav>
            </div>
            <div class="sidebar-footer">
                <nav>
                    <ul>
                         <li><a href="#" data-target="page-model-hub">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0l-2.072-1.036A48.22 48.22 0 0112 3.493a48.22 48.22 0 0111.056 4.616l-2.072 1.036m-14.932 0A50.499 50.499 0 0112 13.489a50.5 50.5 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5z" /></svg>
                            Model Hub
                         </a></li>
                         <li><a href="#" data-target="page-settings">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226l.053-.022c.563-.23 1.18-.166 1.683.197l.052.052c.42.42.684 1.003.684 1.615c0 .612-.264 1.195-.684 1.615l-.052.052c-.504.363-1.12.427-1.683.197l-.053-.022c-.55-.219-1.02-.684-1.11-1.226zM12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /></svg>
                            Settings
                         </a></li>
                    </ul>
                </nav>
                <div class="theme-switch-wrapper">
                    <label style="font-weight:600;">Theme</label>
                    <label class="theme-switch" for="themeToggle">
                        <input type="checkbox" id="themeToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </aside>

        <main class="main-content">
			<!-- =================================================================== -->
			<!-- NEW: Main Content Stage                                           -->
			<!-- All page content will be dynamically injected here from templates -->
			<!-- =================================================================== -->
			<div id="main-content-stage"></div>
        </main>
    </div>

    <!-- ===================================================================================== -->
    <!--                                 PAGE TEMPLATES                                      -->
    <!-- All page content is now stored here, outside the main flow, ready to be cloned. -->
    <!-- ===================================================================================== -->

<template id="template-command-center">
    <div id="page-command-center" class="page-content">
        <header class="page-header">
            <h1>Command Centre</h1>
            <p>Your strategic summary and AI-powered recommendations for growth.</p>
        </header>
        
        <div class="filters-container">
            <div class="filter-group">
                <label for="start-date-filter">Start Date</label>
                <input type="date" id="start-date-filter">
            </div>
             <div class="filter-group">
                <label for="end-date-filter">End Date</label>
                <input type="date" id="end-date-filter">
            </div>
            <div class="filter-group">
                <label for="region-filter">Region</label>
                <select id="region-filter"><!-- Options will be populated by JS --></select>
            </div>
        </div>

        <div class="grid-3" id="kpi-cards-container">
            <div class="loading-overlay" style="display:block; grid-column: 1 / -1;">Loading KPIs...</div>
        </div>

        <div class="panel">
            <div class="panel-header"><h2>Top Recommendations</h2></div>
            <div class="grid-3" style="margin-bottom: 0;" id="recommendations-container">
                 <div class="loading-overlay" style="display:block; grid-column: 1 / -1;">Analyzing data for recommendations...</div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="panel">
                <div class="panel-header"><h2>Performance Drivers</h2></div>
                <ul class="driver-list" id="drivers-container" aria-busy="true">
                   <li class="loading-overlay" style="display:block; list-style:none;">Identifying key drivers...</li>
                </ul>
            </div>
            <div class="panel">
                <div class="panel-header"><h2>Channel ROI Breakdown</h2></div>
                <div class="chart-container"><canvas id="channelRoiChart"></canvas></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2 id="trend-chart-title">Revenue Trend</h2>
                <div class="filter-group" style="margin-bottom:0; flex-direction: row; align-items: center; gap: 10px;">
                    <label for="trend-metric-select" style="margin-bottom:0;">Metric</label>
                    <select id="trend-metric-select" style="height: auto; padding: 6px 10px;">
                        <option value="incremental_conversion_value" selected>Revenue</option>
                        <option value="roas">ROAS</option>
                        <option value="cost">Spend</option>
                        <option value="incremental_conversions">Conversions</option>
                        <option value="cpa">CPA</option>
                        <option value="impressions">Impressions</option>
                        <option value="clicks">Clicks</option>
                    </select>
                </div>
            </div>
            <div class="chart-container" style="height: 200px;"><canvas id="revenueTrendChart"></canvas></div>
        </div>

        <div class="panel">
            <div class="panel-header"><h2>Performance Snapshot</h2></div>
            <div id="performance-snapshot-container">
                <div class="loading-overlay" style="display:block; grid-column: 1 / -1;">Calculating metrics...</div>
            </div>
        </div>
    </div>	
    <!-- Data Island for the page -->
    <script type="application/json" id="dashboard-data">
    [
        {"date":"2025-07-31","grouping_key":"AU","channel":"YouTube Ads","cost":9500,"impressions":1200000,"clicks":9800,"video_views":950000,"incremental_conversions":190,"incremental_conversion_value":34200,"baseline_conversions":350,"baseline_conversion_value":63000,"recommendation_scale":1.05},
        {"date":"2025-07-31","grouping_key":"NZ","channel":"Programmatic Display","cost":1800,"impressions":900000,"clicks":2700,"video_views":0,"incremental_conversions":40,"incremental_conversion_value":5200,"baseline_conversions":80,"baseline_conversion_value":10400,"recommendation_scale":0.92},
        {"date":"2025-07-30","grouping_key":"AU","channel":"Bing Ads","cost":4200,"impressions":350000,"clicks":10500,"video_views":0,"incremental_conversions":150,"incremental_conversion_value":27000,"baseline_conversions":280,"baseline_conversion_value":50400,"recommendation_scale":1.10},
        {"date":"2025-07-29","grouping_key":"AU","channel":"YouTube Ads","cost":9300,"impressions":1150000,"clicks":9600,"video_views":920000,"incremental_conversions":185,"incremental_conversion_value":33300,"baseline_conversions":340,"baseline_conversion_value":61200,"recommendation_scale":1.03},
        {"date":"2025-07-29","grouping_key":"AU","channel":"Pinterest Ads","cost":3100,"impressions":450000,"clicks":4500,"video_views":50000,"incremental_conversions":95,"incremental_conversion_value":14250,"baseline_conversions":150,"baseline_conversion_value":22500,"recommendation_scale":0.98},
        {"date":"2025-07-28","grouping_key":"NZ","channel":"YouTube Ads","cost":2200,"impressions":300000,"clicks":2500,"video_views":240000,"incremental_conversions":55,"incremental_conversion_value":7150,"baseline_conversions":90,"baseline_conversion_value":11700,"recommendation_scale":1.01},
        {"date":"2025-07-27","grouping_key":"AU","channel":"Snapchat Ads","cost":4800,"impressions":1500000,"clicks":12000,"video_views":600000,"incremental_conversions":130,"incremental_conversion_value":19500,"baseline_conversions":200,"baseline_conversion_value":30000,"recommendation_scale":0.95},
        {"date":"2025-07-26","grouping_key":"AU","channel":"Bing Ads","cost":4100,"impressions":340000,"clicks":10200,"video_views":0,"incremental_conversions":145,"incremental_conversion_value":26100,"baseline_conversions":270,"baseline_conversion_value":48600,"recommendation_scale":1.08},
        {"date":"2025-07-25","grouping_key":"AU","channel":"LinkedIn Ads","cost":5500,"impressions":250000,"clicks":2000,"video_views":0,"incremental_conversions":50,"incremental_conversion_value":15000,"baseline_conversions":90,"baseline_conversion_value":27000,"recommendation_scale":0.88},
        {"date":"2025-07-24","grouping_key":"AU","channel":"Programmatic Display","cost":3500,"impressions":1800000,"clicks":5400,"video_views":0,"incremental_conversions":70,"incremental_conversion_value":12600,"baseline_conversions":130,"baseline_conversion_value":23400,"recommendation_scale":0.90},
        {"date":"2025-07-23","grouping_key":"NZ","channel":"Bing Ads","cost":1500,"impressions":120000,"clicks":3600,"video_views":0,"incremental_conversions":60,"incremental_conversion_value":7800,"baseline_conversions":100,"baseline_conversion_value":13000,"recommendation_scale":1.12},
        {"date":"2025-07-22","grouping_key":"AU","channel":"YouTube Ads","cost":9000,"impressions":1100000,"clicks":9100,"video_views":880000,"incremental_conversions":180,"incremental_conversion_value":32400,"baseline_conversions":330,"baseline_conversion_value":59400,"recommendation_scale":1.02},
        {"date":"2025-07-21","grouping_key":"AU","channel":"Pinterest Ads","cost":3000,"impressions":440000,"clicks":4300,"video_views":48000,"incremental_conversions":92,"incremental_conversion_value":13800,"baseline_conversions":145,"baseline_conversion_value":21750,"recommendation_scale":0.97},
        {"date":"2025-07-20","grouping_key":"AU","channel":"Snapchat Ads","cost":4600,"impressions":1450000,"clicks":11800,"video_views":580000,"incremental_conversions":125,"incremental_conversion_value":18750,"baseline_conversions":190,"baseline_conversion_value":28500,"recommendation_scale":0.94},
        {"date":"2025-07-19","grouping_key":"NZ","channel":"Programmatic Display","cost":1700,"impressions":850000,"clicks":2550,"video_views":0,"incremental_conversions":38,"incremental_conversion_value":4940,"baseline_conversions":75,"baseline_conversion_value":9750,"recommendation_scale":0.91},
        {"date":"2025-07-18","grouping_key":"AU","channel":"LinkedIn Ads","cost":5200,"impressions":240000,"clicks":1900,"video_views":0,"incremental_conversions":48,"incremental_conversion_value":14400,"baseline_conversions":85,"baseline_conversion_value":25500,"recommendation_scale":0.85},
        {"date":"2025-07-17","grouping_key":"AU","channel":"Bing Ads","cost":3900,"impressions":320000,"clicks":9900,"video_views":0,"incremental_conversions":140,"incremental_conversion_value":25200,"baseline_conversions":260,"baseline_conversion_value":46800,"recommendation_scale":1.06},
        {"date":"2025-08-19","grouping_key":"AU","channel":"Google Ads","cost":8200,"impressions":850000,"clicks":12750,"video_views":0,"incremental_conversions":250,"incremental_conversion_value":45000,"baseline_conversions":500,"baseline_conversion_value":90000,"recommendation_scale":0.95},
        {"date":"2025-08-19","grouping_key":"AU","channel":"DV360","cost":5100,"impressions":450000,"clicks":12750,"video_views":0,"incremental_conversions":210,"incremental_conversion_value":40000,"baseline_conversions":500,"baseline_conversion_value":90000,"recommendation_scale":0.95},
        {"date":"2025-08-19","grouping_key":"AU","channel":"Facebook Ads","cost":6500,"impressions":950000,"clicks":9500,"video_views":150000,"incremental_conversions":180,"incremental_conversion_value":32400,"baseline_conversions":400,"baseline_conversion_value":72000,"recommendation_scale":0.90},
        {"date":"2025-08-19","grouping_key":"AU","channel":"TV","cost":15000,"impressions":5000000,"clicks":0,"video_views":5000000,"incremental_conversions":120,"incremental_conversion_value":21600,"baseline_conversions":800,"baseline_conversion_value":144000,"recommendation_scale":0.75},
        {"date":"2025-08-19","grouping_key":"NZ","channel":"Google Ads","cost":3500,"impressions":400000,"clicks":6000,"video_views":0,"incremental_conversions":110,"incremental_conversion_value":15400,"baseline_conversions":200,"baseline_conversion_value":28000,"recommendation_scale":0.98},
        {"date":"2025-08-18","grouping_key":"AU","channel":"Google Ads","cost":8100,"impressions":840000,"clicks":12600,"video_views":0,"incremental_conversions":245,"incremental_conversion_value":44100,"baseline_conversions":495,"baseline_conversion_value":89100,"recommendation_scale":0.94},
        {"date":"2025-08-18","grouping_key":"AU","channel":"Facebook Ads","cost":6400,"impressions":940000,"clicks":9400,"video_views":148000,"incremental_conversions":178,"incremental_conversion_value":32040,"baseline_conversions":398,"baseline_conversion_value":71640,"recommendation_scale":0.89},
        {"date":"2025-08-17","grouping_key":"AU","channel":"Google Ads","cost":7900,"impressions":820000,"clicks":12300,"video_views":0,"incremental_conversions":235,"incremental_conversion_value":42300,"baseline_conversions":485,"baseline_conversion_value":87300,"recommendation_scale":0.93},
        {"date":"2025-08-16","grouping_key":"AU","channel":"TikTok","cost":4500,"impressions":1300000,"clicks":16000,"video_views":450000,"incremental_conversions":160,"incremental_conversion_value":24000,"baseline_conversions":210,"baseline_conversion_value":31500,"recommendation_scale":1.02},
        {"date":"2025-08-15","grouping_key":"NZ","channel":"Google Ads","cost":3600,"impressions":410000,"clicks":6150,"video_views":0,"incremental_conversions":115,"incremental_conversion_value":16100,"baseline_conversions":205,"baseline_conversion_value":28700,"recommendation_scale":0.98},
        {"date":"2025-08-14","grouping_key":"AU","channel":"Facebook Ads","cost":6300,"impressions":930000,"clicks":9300,"video_views":145000,"incremental_conversions":175,"incremental_conversion_value":31500,"baseline_conversions":395,"baseline_conversion_value":71100,"recommendation_scale":0.87},
        {"date":"2025-08-13","grouping_key":"AU","channel":"Google Ads","cost":7600,"impressions":815000,"clicks":12100,"video_views":0,"incremental_conversions":232,"incremental_conversion_value":41760,"baseline_conversions":482,"baseline_conversion_value":86760,"recommendation_scale":0.91},
        {"date":"2025-08-12","grouping_key":"AU","channel":"Facebook Ads","cost":6200,"impressions":920000,"clicks":9200,"video_views":140000,"incremental_conversions":170,"incremental_conversion_value":30600,"baseline_conversions":390,"baseline_conversion_value":70200,"recommendation_scale":0.85},
        {"date":"2025-08-12","grouping_key":"NZ","channel":"Facebook Ads","cost":2500,"impressions":500000,"clicks":4500,"video_views":80000,"incremental_conversions":80,"incremental_conversion_value":10400,"baseline_conversions":150,"baseline_conversion_value":19500,"recommendation_scale":0.80},
        {"date":"2025-08-12","grouping_key":"AU","channel":"TikTok","cost":4000,"impressions":1200000,"clicks":15000,"video_views":400000,"incremental_conversions":150,"incremental_conversion_value":22500,"baseline_conversions":200,"baseline_conversion_value":30000,"recommendation_scale":1.00},
        {"date":"2025-08-12","grouping_key":"NZ","channel":"TikTok","cost":2000,"impressions":600000,"clicks":7500,"video_views":200000,"incremental_conversions":70,"incremental_conversion_value":9100,"baseline_conversions":100,"baseline_conversion_value":13000,"recommendation_scale":0.97},
        {"date":"2025-08-12","grouping_key":"AU","channel":"Google Ads","cost":7500,"impressions":810000,"clicks":12000,"video_views":0,"incremental_conversions":230,"incremental_conversion_value":41400,"baseline_conversions":480,"baseline_conversion_value":86400,"recommendation_scale":0.90},
        {"date":"2025-08-01","grouping_key":"AU","channel":"Facebook Ads","cost":6000,"impressions":900000,"clicks":9000,"video_views":130000,"incremental_conversions":160,"incremental_conversion_value":28800,"baseline_conversions":380,"baseline_conversion_value":68400,"recommendation_scale":0.82}
    ]
    </script>
</template>

    <template id="template-dashboard">
        <div id="page-dashboard" class="page-content">
            <header class="page-header">
                <h1>Performance Dashboard</h1>
                <p>High-level overview of marketing performance and ROI.</p>
            </header>
            <div class="panel">
                <div class="filter-bar">
                    <div style="flex-grow: 1;">
                       <label for="model-version">Model Version</label>
                       <select id="model-version">
                           <option>Atlas v3.1 (Live)</option>
                           <option>Atlas v3.0 (Archived)</option>
                       </select>
                    </div>
                    <div style="flex-grow: 1;">
                        <label for="date-range">Date Range</label>
                        <input type="text" id="date-range" value="01 Jan 2024 - 30 Jun 2024">
                    </div>
                     <div style="align-self: flex-end; margin-bottom: 15px;">
                        <button>Apply</button>
                     </div>
                </div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="label">Total Marketing ROI</div><div class="value">4.21x</div><div class="change positive">+5.2% vs prev. period</div></div>
                <div class="kpi-card"><div class="label">Total Attributed Revenue</div><div class="value">$12.7M</div><div class="change positive">+8.1% vs prev. period</div></div>
                <div class="kpi-card"><div class="label">Total Spend</div><div class="value">$3.01M</div><div class="change negative">-2.4% vs prev. period</div></div>
                <div class="kpi-card"><div class="label">Avg. MROAS</div><div class="value">1.15</div><div class="change positive">+3.5% vs prev. period</div></div>
            </div>
            <div class="panel">
                <div class="panel-header"><h2>Revenue Contribution by Channel<small>Breakdown of total attributed revenue</small></h2></div>
                <div class="chart-container">
                    <canvas id="contributionChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><h2>Overall ROI Trend<small>Blended marketing ROI over the selected period</small></h2></div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="roiTrendChart"></canvas>
                </div>
            </div>
        </div>
    </template>

    <template id="template-deep-dive">
        <div id="page-deep-dive" class="page-content">
             <header class="page-header">
                <h1>Channel Deep Dive</h1>
                <p>Analyze individual channel performance and response curves.</p>
            </header>
            <div class="panel">
                <div class="panel-header"><h2>Select Channel for Analysis</h2></div>
                <select id="channel-selector">
                    <option>Paid Search</option>
                    <option>Paid Social</option>
                    <option>TV</option>
                    <option>Out of Home</option>
                    <option>Sponsorships</option>
                </select>
            </div>
             <div class="panel">
                <div class="panel-header"><h2 id="performance-panel-title">Paid Search: Performance<small>Key metrics for the selected channel</small></h2></div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="label">Channel ROI</div><div id="kpi-roi-value" class="value">5.89x</div></div>
                    <div class="kpi-card"><div class="label">Attributed Revenue</div><div id="kpi-revenue-value" class="value">$4.2M</div></div>
                    <div class="kpi-card"><div class="label">Spend</div><div id="kpi-spend-value" class="value">$713k</div></div>
                    <div class="kpi-card"><div class="label">Saturation Point</div><div id="kpi-saturation-value" class="value">~85%</div></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><h2 id="response-curve-panel-title">Paid Search: Response Curve<small>Diminishing returns based on spend level</small></h2></div>
                <div class="chart-container">
                    <canvas id="responseCurveChart"></canvas>
                </div>
            </div>
        </div>
    </template>

<template id="template-simulator">
    <div id="page-simulator" class="page-content">
        <header class="page-header">
           <h1>Budget Simulator</h1>
           <p>Project outcomes by reallocating your marketing budget.</p>
       </header>

       <div class="panel">
            <div class="panel-header">
                <h2>Configuration <small>Adjust simulation dates, grouping, and active channels</small></h2>
            </div>
            <div class="config-grid">
                <div class="config-item" id="date-range-group-wrapper">
                    <label>Simulation Period
                        <span class="info-helper">
                            <span class="info-icon">?</span>
                            <span class="info-tooltip">Select the start and end dates for your budget simulation. The duration affects total spend calculations and seasonality adjustments.</span>
                        </span>
                    </label>
                    <div class="date-input-container">
                        <input type="date" id="startDate" name="startDate">
                        <span class="date-separator">to</span>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                </div>

                <div class="config-item" id="duration-kpi-wrapper">
                    <label>Duration</label>
                    <div id="sim-duration" class="kpi-value">30 Days</div>
                </div>
                
                <div class="config-item" id="grouping-key-wrapper">
                    <label for="groupingKeySelect">Grouping Key
                        <span class="info-helper">
                            <span class="info-icon">?</span>
                            <span class="info-tooltip">Choose a key to filter the available models and apply relevant seasonality. This is typically a country or region, allowing for specialised analysis.</span>
                        </span>
                    </label>
                    <select id="groupingKeySelect"></select>
                </div>
                
                <div class="config-item" id="channel-select-wrapper">
                    <label for="channelSelectDisplay">Active Channels</label>
                    <div id="channelSelectContainer" class="multi-select-container">
                        <div id="channelSelectDisplay" class="multi-select-display">Select channels...</div>
                        <div id="channelSelectDropdown" class="multi-select-dropdown">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </div>
            </div>
       </div>
       
       <div class="panel">
           <div class="panel-header">
                <h2>Budget Allocation<small>Adjust sliders to reallocate spend for the selected period</small></h2>
                <div style="text-align: right;">
                    <label>Total Budget
                        <span class="info-helper">
                            <span class="info-icon">?</span>
                            <span class="info-tooltip">This is the combined total spend for all active channels in the simulation period, based on the current slider positions.</span>
                        </span>
                    </label>
                    <h3 style="margin:0; color: var(--atlas-gold); font-size: 1.8em;" id="totalBudgetDisplay">$0</h3>
                </div>
            </div>
            <div id="budget-allocator">
                <!-- JS will populate this section -->
            </div>
       </div>
       
       <div class="panel">
            <div class="panel-header"><h2>Projected Outcomes<small>Estimated results based on your new allocation. Figures are derived from total revenue, not incremental revenue. </small></div>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="label">Projected Total ROI
                    <span class="info-helper">
                        <span class="info-icon">?</span>
                        <span class="info-tooltip">Return On Investment. Calculated as (Projected Holistic Revenue / Total Spend). A value of 2.50x means you get $2.50 in revenue for every $1 spent.</span>
                    </span>
                </div><div id="sim-roi" class="value">0.00x</div></div>
                <div class="kpi-card"><div class="label">Projected Holistic Revenue
                    <span class="info-helper">
                        <span class="info-icon">?</span>
                        <span class="info-tooltip">The total estimated revenue generated across the entire business, influenced by the specified marketing spend. This accounts for baseline revenue and the combined, weighted impact of all active channels.</span>
                    </span>
                </div><div id="sim-revenue" class="value">$0M</div></div>
                <div class="kpi-card"><div class="label">Spend Change</div><div id="sim-spend-change" class="value">$0</div></div>
            </div>
       </div>

       <div class="panel panel-advanced">
            <div class="panel-header">
                <h2>Atlas Tensor Engine
                    <span class="info-helper">
                        <span class="info-icon">?</span>
                        <span class="info-tooltip">The Tensor Engine uses machine learning to try and find the most efficient budget allocation that meets your goals. It considers each channel's unique performance curve to maximise overall ROI.</span>
                    </span>
                    <small>Leverage Atlas's TensorFlow neural networks to compute the most ROI-efficient allocation for your target.</small>
                </h2>
            </div>
            <div class="optimizer-grid">
                <div>
                    <label for="revenueTarget">Revenue Target ($)
                        <span class="info-helper">
                            <span class="info-icon">?</span>
                            <span class="info-tooltip">Enter your desired total holistic revenue for the period. The optimiser will attempt to find the lowest-spend allocation to achieve this target.</span>
                        </span>
                    </label>
                    <input type="text" id="revenueTarget" placeholder="e.g., 2,500,000">
                </div>
                <div>
                    <label for="budgetConstraint">Optional Budget Constraint ($)
                        <span class="info-helper">
                            <span class="info-icon">?</span>
                            <span class="info-tooltip">Set a maximum total budget. The optimiser will find the best possible revenue outcome without exceeding this spend limit. Leave blank for no constraint.</span>
                        </span>
                    </label>
                    <input type="text" id="budgetConstraint" placeholder="e.g., 1,500,000">
                </div>
                <div>
                    <button id="optimizeBtn" class="atlas-button">Find Optimal Allocation</button>
                </div>
            </div>
            <div id="optimizer-progress" style="display: none; margin-top: 20px;">
                <div id="progress-text" style="margin-bottom: 8px; font-size: 0.9em; color: var(--atlas-text-secondary);">Optimizing...</div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar-inner"></div>
                </div>
            </div>
            
            <div id="tensor-visualization-placeholder"></div>
       </div>
    </div>

    <!-- Data Islands required by this page's JavaScript -->
    <script type="application/json" id="channelData">[
      {"grouping_key":"NZ","channel":"Google Ads - Performance Max","avg_spend":12121.38796,"spend_std_dev":5331.663103,"max_daily_spend":43760.15,"significance_weight":180227.89,"model_name":"Piecewise","equation_value":"Piecewise at x=132873.3300000000: [y=3275830.9538966231+86.8439489037*x, y=88763.3502937835+70.4240801212*x]","r_squared_value":0.5948510112,"aggregation_level_value":15,"simplified_structure_value":"y = {p2}+{p3}*x if x<{p1}; y={p4}+{p5}*x if x>={p1}","p1_value":132873.33,"p2_value":3275830.95,"p3_value":86.84,"p4_value":88763.35,"p5_value":70.42},
      {"grouping_key":"AU","channel":"TheTradeDesk - Performance Display","avg_spend":723.6719794,"spend_std_dev":243.5796803,"max_daily_spend":1909.198641,"significance_weight":128796.37,"model_name":"Quadratic","equation_value":"y = 11176059.4188461006 + -762.7439413713*x + 0.0834086250*x^2","r_squared_value":0.349897491,"aggregation_level_value":13,"simplified_structure_value":"y = {p1} + {p2}*x + {p3}*x^{p4}","p1_value":11176059.42,"p2_value":-762.7439414,"p3_value":0.083408625,"p4_value":2,"p5_value":null},
      {"grouping_key":"AU","channel":"Snapchat Ads - Conversion","avg_spend":640.6089579,"spend_std_dev":524.6633067,"max_daily_spend":4926.53,"significance_weight":122752.14,"model_name":"Logarithmic","equation_value":"y = -20889511.8966794014 + 3745851.1221454539 * ln(x)","r_squared_value":0.4886072593,"aggregation_level_value":14,"simplified_structure_value":"y = {p1} + {p2} * ln(x)","p1_value":-20889511.9,"p2_value":3745851.122,"p3_value":null,"p4_value":null,"p5_value":null},
      {"grouping_key":"AU","channel":"Pinterest - Conversions","avg_spend":1054.302624,"spend_std_dev":918.0633752,"max_daily_spend":5935.1,"significance_weight":112452.56,"model_name":"Power","equation_value":"y = 593694.2145581654 * x^0.3142955653","r_squared_value":0.3474797636,"aggregation_level_value":14,"simplified_structure_value":"y = {p1} * x^{p2}","p1_value":593694.2146,"p2_value":0.3142955653,"p3_value":null,"p4_value":null,"p5_value":null},
      {"grouping_key":"AU","channel":"Facebook Ads - Facebook","avg_spend":6306.719948,"spend_std_dev":3413.412466,"max_daily_spend":22653.45,"significance_weight":38598.59,"model_name":"SCurve","equation_value":"y = 25608381.3600 / (1 + exp(-0.000009 * (x - 92735.4527)))","r_squared_value":0.3607778042,"aggregation_level_value":14,"simplified_structure_value":"y = {p1} / ({p2} + exp({p3} * (x - {p4})))","p1_value":25608381.36,"p2_value":1,"p3_value":-0.000009,"p4_value":92735.4527,"p5_value":null},
      {"grouping_key":"AU","channel":"TikTok - Conversions","avg_spend":2290.463925,"spend_std_dev":1309.678577,"max_daily_spend":9280.06,"significance_weight":25183.68,"model_name":"Exponential","equation_value":"y = 7718771.4143208070 * exp(0.0000135380 * x)","r_squared_value":0.2004082265,"aggregation_level_value":14,"simplified_structure_value":"y = {p1} * exp({p2} * x)","p1_value":7718771.414,"p2_value":0.000013538,"p3_value":null,"p4_value":null,"p5_value":null},
      {"grouping_key":"AU","channel":"Google Ads - Search","avg_spend":5484.116776,"spend_std_dev":3231.034401,"max_daily_spend":27774.06,"significance_weight":21447.08,"model_name":"Linear","equation_value":"y = 6688946.7800918808 + 53.5669809694*x","r_squared_value":0.363113286,"aggregation_level_value":11,"simplified_structure_value":"y = {p1} + {p2}*x","p1_value":6688946.78,"p2_value":53.57,"p3_value":null,"p4_value":null,"p5_value":null},
      {"grouping_key":"AU","channel":"DV360 - BVOD","avg_spend":1740.39396,"spend_std_dev":1372.020194,"max_daily_spend":7786.17,"significance_weight":1000.7,"model_name":"Inverse","equation_value":"y = 12883687.0047456771 + -45780019890.1131286621 * (1/x)","r_squared_value":0.8393706279,"aggregation_level_value":13,"simplified_structure_value":"y = {p1} + {p2} * ({p3}/x)","p1_value":12883687,"p2_value":-45780019890,"p3_value":1,"p4_value":null,"p5_value":null}
    ]</script>
    <script type="application/json" id="seasonalityData">[
      {"grouping_key":"AU","seasonality_type":"DOY","index":1,"conversion_value_seasonality_index":0.9921868996},
      {"grouping_key":"AU","seasonality_type":"DOY","index":2,"conversion_value_seasonality_index":1.032250336},
      {"grouping_key":"AU","seasonality_type":"DOY","index":3,"conversion_value_seasonality_index":1.075500803},
      {"grouping_key":"AU","seasonality_type":"DOY","index":4,"conversion_value_seasonality_index":1.125705863},
      {"grouping_key":"AU","seasonality_type":"DOY","index":5,"conversion_value_seasonality_index":1.100892088},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Sunday","conversion_value_seasonality_index":0.844670292},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Monday","conversion_value_seasonality_index":0.9715354138},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Tuesday","conversion_value_seasonality_index":1.000390324},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Wednesday","conversion_value_seasonality_index":1.024218072},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Thursday","conversion_value_seasonality_index":1.215081725},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Friday","conversion_value_seasonality_index":1.074237667},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Saturday","conversion_value_seasonality_index":0.9111426206},
      {"grouping_key":"AU","seasonality_type":"DOY","index":1,"conversion_value_seasonality_index":1.01},
      {"grouping_key":"AU","seasonality_type":"DOY","index":2,"conversion_value_seasonality_index":1.02},
      {"grouping_key":"AU","seasonality_type":"DOW","index":"Sunday","conversion_value_seasonality_index":0.90}
    ]</script>
</template>

    <template id="template-shapley-analysis">
        <div id="page-shapley-analysis" class="page-content">
            <header class="page-header">
                <h1>Shapley Value Analysis</h1>
                <p>Understand the true marginal contribution of each marketing channel, accounting for all interactions.</p>
            </header>
            <div class="panel">
                <div class="filter-bar">
                    <div style="flex-grow: 1;">
                       <label for="shapley-metric">Metric to Analyze</label>
                       <select id="shapley-metric">
                           <option>Total Attributed Revenue</option>
                           <option>Total Conversions</option>
                           <option>New Customer Acquisitions</option>
                       </select>
                    </div>
                    <div style="flex-grow: 1;">
                        <label for="shapley-date-range">Date Range</label>
                        <input type="text" id="shapley-date-range" value="01 Jan 2024 - 30 Jun 2024">
                    </div>
                     <div style="align-self: flex-end; margin-bottom: 15px;">
                        <button>Analyze</button>
                     </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2>Channel Contributions to Total Revenue</h2>
                    <small>Waterfall chart showing how each channel's contribution builds to the final total.</small>
                </div>
                <div class="waterfall-chart">
                    <div class="waterfall-item">
                        <div class="waterfall-bar base" style="bottom: 40px; height: 66px;"></div><div class="waterfall-value" style="bottom: 111px;">$3.0M</div><div class="waterfall-label">Base Revenue</div><div class="connector" style="bottom: 106px;"></div>
                    </div>
                    <div class="waterfall-item">
                        <div class="waterfall-bar positive" style="bottom: 106px; height: 93px;"></div><div class="waterfall-value" style="bottom: 204px;">+$4.2M</div><div class="waterfall-label">Paid Search</div><div class="connector" style="bottom: 199px;"></div>
                    </div>
                    <div class="waterfall-item">
                        <div class="waterfall-bar positive" style="bottom: 199px; height: 62px;"></div><div class="waterfall-value" style="bottom: 266px;">+$2.8M</div><div class="waterfall-label">Paid Social</div><div class="connector" style="bottom: 261px;"></div>
                    </div>
                    <div class="waterfall-item">
                        <div class="waterfall-bar positive" style="bottom: 261px; height: 33px;"></div><div class="waterfall-value" style="bottom: 299px;">+$1.5M</div><div class="waterfall-label">TV</div><div class="connector" style="bottom: 294px;"></div>
                    </div>
                    <div class="waterfall-item">
                        <div class="waterfall-bar negative" style="bottom: 287px; height: 7px;"></div><div class="waterfall-value" style="bottom: 262px;">-$0.3M</div><div class="waterfall-label">Cannibalization</div><div class="connector" style="bottom: 287px;"></div>
                    </div>
                    <div class="waterfall-item">
                        <div class="waterfall-bar positive" style="bottom: 287px; height: 33px;"></div><div class="waterfall-value" style="bottom: 325px;">+$1.5M</div><div class="waterfall-label">Other</div><div class="connector" style="bottom: 320px;"></div>
                    </div>
                    <div class="waterfall-item">
                        <div class="waterfall-bar total" style="bottom: 40px; height: 280px;"></div><div class="waterfall-value" style="bottom: 325px;">$12.7M</div><div class="waterfall-label">Total Revenue</div><div class="connector"></div>
                    </div>
                </div>
            </div>
            <div class="grid-2">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Contribution Drill-Down</h2>
                        <select id="drilldown-channel-selector" style="max-width: 200px; margin-bottom: 0;"><option>Paid Search</option><option>Paid Social</option><option>TV</option></select>
                    </div>
                    <div id="shapley-drilldown-container" class="drilldown-text-list"></div>
                </div>
                <div id="shapley-insight-card" class="insight-card"></div>
            </div>
        </div>
    </template>
    
    <template id="template-granular-reporting">
        <div id="page-granular-reporting" class="page-content">
            <header class="page-header">
                <h1>Granular Performance</h1>
                <p>Daily performance breakdown by channel, campaign, and targeting.</p>
            </header>
            <div class="panel">
                <div class="panel-header">
                    <h2>Performance Breakdown</h2>
                    <div class="filter-bar" id="groupBy-controls">
                        <button class="control-btn active" data-group="channel">By Channel</button>
                        <button class="control-btn" data-group="campaign">By Campaign</button>
                        <button class="control-btn" data-group="targeting">By Targeting Type</button>
                    </div>
                </div>
                <div class="chart-container" style="height: 350px; margin-bottom: 30px;">
                    <canvas id="performance-breakdown-chart"></canvas>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid var(--atlas-border-color);">
                            <th id="table-group-header" style="padding: 12px 15px; width: 30%;">Channel</th>
                            <th style="padding: 12px 15px;">Total Spend</th><th style="padding: 12px 15px;">Attributed Revenue</th>
                            <th style="padding: 12px 15px;">Impressions</th><th style="padding: 12px 15px;">Clicks</th>
                            <th style="padding: 12px 15px;">Video Views</th><th style="padding: 12px 15px;">Calculated ROI</th>
                        </tr>
                    </thead>
                    <tbody id="performance-table-body"></tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="template-incrementality">
        <div id="page-incrementality" class="page-content">
            <header class="page-header">
                <h1>Incrementality</h1>
                <p>Analyse the additional revenue generated on top of your baseline performance.</p>
            </header>
            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div class="kpi-card"><div class="kpi-label">Total Baseline Revenue</div><div class="kpi-value" id="total-baseline-value">$0M</div></div>
                <div class="kpi-card" style="border-left: 3px solid var(--atlas-accent-color); padding-left: 18px;"><div class="kpi-label">Total Incremental Revenue</div><div class="kpi-value" id="total-incremental-value">$0M</div></div>
                <div class="kpi-card" style="border-left: 3px solid var(--atlas-accent-color); padding-left: 18px;"><div class="kpi-label">Overall Lift</div><div class="kpi-value" id="overall-lift-value">0.00%</div><div class="kpi-change positive" id="overall-lift-change">+0.00% vs last period</div></div>
                <div class="kpi-card" style="border-left: 3px solid var(--atlas-accent-color); padding-left: 18px;"><div class="kpi-label">Incremental to Baseline Ratio</div><div class="kpi-value" id="incrementality-ratio-value">0.00%</div></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2>Weekly Revenue Breakdown</h2>
                     <div class="filter-bar"><select id="incrementality-timeframe-filter" style="width: 200px;"><option value="90">Last 90 Days</option><option value="60">Last 60 Days</option><option value="30">Last 30 Days</option></select></div>
                </div>
                <div class="chart-wrapper" style="display: flex; gap: 15px; padding: 20px;">
                    <div class="chart-y-axis" style="display: flex; flex-direction: column; justify-content: space-between; text-align: right; color: var(--atlas-text-secondary); font-size: 12px; padding-right: 15px; border-right: 1px solid var(--atlas-border-color); min-height: 400px; padding-bottom: 50px;"></div>
                    <div id="incrementality-chart-area" style="flex-grow: 1; display: flex; align-items: flex-end; justify-content: space-around; gap: 2%; min-height: 400px; border-bottom: 1px solid var(--atlas-border-color); padding-bottom: 10px;"></div>
                </div>
                <div class="chart-legend" style="padding: 15px 20px; display: flex; justify-content: center; gap: 20px; border-top: 1px solid var(--atlas-border-color-light);">
                    <div style="display:flex; align-items:center; font-size: 14px;"><div style="width:12px; height: 12px; background-color: var(--atlas-gray-600); margin-right: 8px; border-radius: 2px;"></div>Baseline Revenue</div>
                    <div style="display:flex; align-items:center; font-size: 14px;"><div style="width:12px; height: 12px; background-color: var(--atlas-accent-color); margin-right: 8px; border-radius: 2px;"></div>Incremental Revenue</div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-funnel">
        <div id="page-funnel" class="page-content">
            <header class="page-header">
                <h1>Funnel Breakdown</h1>
                <p>Analyze performance across each stage of the customer journey.</p>
            </header>
            <div class="panel">
                <div class="panel-header">
                    <h2>Performance by Stage</h2>
                    <div class="filter-bar">
                        <label for="funnel-data-source" style="margin-right: 8px; font-size: 14px; color: var(--atlas-text-secondary);">Data Source:</label>
                        <select id="funnel-data-source" style="width: 220px;"><option value="overall">Overall Performance</option><option value="q2_social">Q2 Social Campaign</option><option value="q3_search">Q3 Search Initiative</option></select>
                    </div>
                </div>
                <style>
                    .funnel-container { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 20px 0; }
                    .funnel-stage { display: flex; align-items: center; width: 100%; gap: 30px; }
                    .funnel-visual { flex-shrink: 0; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.1rem; color: var(--atlas-text-primary); text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
                    .funnel-connector { border-top: 2px dotted var(--atlas-border-color); width: 30px; }
                    .funnel-metrics { flex-grow: 1; }
                    #funnel-awareness-visual { width: 300px; height: 90px; background: linear-gradient(to top, #c0a16b, #d9b679); clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%); }
                    #funnel-consideration-visual { width: 220px; height: 90px; background: linear-gradient(to top, #c0a16b, #d9b679); clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%); }
                    #funnel-decision-visual { width: 140px; height: 90px; background: linear-gradient(to top, #c0a16b, #d9b679); clip-path: polygon(0 0, 100% 0, 65% 100%, 35% 100%); }
                </style>
                <div class="funnel-container">
                    <div class="funnel-stage">
                        <div id="funnel-awareness-visual" class="funnel-visual">AWARENESS</div><div class="funnel-connector"></div>
                        <div class="funnel-metrics"><div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr);"><div class="kpi-card"><span>Shapley Value %</span><h2 id="awareness-shapley">...</h2></div><div class="kpi-card"><span>Investment</span><h2 id="awareness-investment">...</h2></div><div class="kpi-card"><span>Conversion Value</span><h2 id="awareness-conv-value">...</h2></div><div class="kpi-card"><span>ROAS</span><h2 id="awareness-roas">...</h2></div></div></div>
                    </div>
                    <div class="funnel-stage">
                        <div id="funnel-consideration-visual" class="funnel-visual">CONSIDERATION</div><div class="funnel-connector"></div>
                        <div class="funnel-metrics"><div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr);"><div class="kpi-card"><span>Shapley Value %</span><h2 id="consideration-shapley">...</h2></div><div class="kpi-card"><span>Investment</span><h2 id="consideration-investment">...</h2></div><div class="kpi-card"><span>Conversion Value</span><h2 id="consideration-conv-value">...</h2></div><div class="kpi-card"><span>ROAS</span><h2 id="consideration-roas">...</h2></div></div></div>
                    </div>
                    <div class="funnel-stage">
                        <div id="funnel-decision-visual" class="funnel-visual">DECISION</div><div class="funnel-connector"></div>
                        <div class="funnel-metrics"><div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr);"><div class="kpi-card"><span>Shapley Value %</span><h2 id="decision-shapley">...</h2></div><div class="kpi-card"><span>Investment</span><h2 id="decision-investment">...</h2></div><div class="kpi-card"><span>Conversion Value</span><h2 id="decision-conv-value">...</h2></div><div class="kpi-card"><span>ROAS</span><h2 id="decision-roas">...</h2></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-next-best-move">
        <div id="page-next-best-move" class="page-content">
            <style>.nbm-chip{display:inline-block;background-color:var(--atlas-bg-primary);border:1px solid var(--atlas-border-color);padding:6px 12px;border-radius:20px;font-size:.9em;font-weight:600;margin:0 8px 8px 0}.nbm-move-card{text-align:center;padding:20px;background:var(--atlas-bg-primary);border-radius:8px;margin-bottom:25px}.nbm-move-card h3{margin:0 0 10px;font-size:1.8em;color:var(--atlas-text-primary)}.nbm-move-card h3 .move-notation{color:var(--atlas-gold);font-family:monospace}.nbm-move-card p{margin:0;font-size:1.1em;color:var(--atlas-text-secondary)}.alt-move-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--atlas-border-color-light)}.alt-move-item:last-child{border-bottom:none}.alt-move-item .pruned-tag{font-size:.8em;color:var(--atlas-text-secondary);font-style:italic;cursor:help}</style>
            <header class="page-header"><h1>Optimal Plays</h1><p>The Atlas engine identifies the next moves with maximum marketing utility.</p></header>
            <div class="panel"><div class="panel-header"><h2>Current Board State</h2><div class="kpi-card" style="padding:10px 20px;border-left-width:0"><div class="label" style="margin-bottom:4px">Total Utility Score</div><div id="total-utility-score" class="value" style="font-size:2em">85.2</div></div></div><div id="game-state-strip" class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"></div></div>
            <div class="panel"><div class="panel-header"><h2>Engine Recommendation</h2><button id="why-btn" class="small-btn">Explore Other Moves</button></div><div class="nbm-move-card"><p>Next Best Move:</p><h3 id="recommendation-title">Shift $15k from <span class="move-notation">Meta → YouTube</span></h3></div><div class="grid-3" style="margin-bottom:25px"><div class="kpi-card"><div class="label">Incremental Revenue</div><div id="rec-lift" class="value change positive">+$240k</div></div><div class="kpi-card"><div class="label">ROAS Lift</div><div id="rec-roas" class="value change positive">+0.12 pts</div></div><div class="kpi-card"><div class="label">Confidence</div><div id="rec-confidence" class="value">92%</div></div></div><button id="commit-move-btn" style="width:100%"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;margin-right:8px"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg> Commit & Schedule Move</button><div id="move-explorer-drawer" style="display:none;margin-top:25px;border-top:1px solid var(--atlas-border-color);padding-top:20px"><h4>Alternative Moves</h4><div id="alternative-moves-list"></div></div></div>
            <div class="grid-2"><div><div class="panel"><div class="panel-header"><h2>Determinant Factors</h2></div><div id="causal-driver-chips"></div></div><div class="panel"><div class="panel-header"><h2>Risk Radar</h2></div><div class="chart-container" style="height:250px"><canvas id="risk-radar-chart"></canvas></div></div></div><div><div class="panel"><div class="panel-header"><h2>Simulation Sandbox</h2><div id="human-vs-engine-score" class="change" style="font-weight:700">Engine is optimal</div></div><div id="simulation-sandbox"></div></div><div class="panel"><div class="panel-header"><h2>Look-Ahead Forecast</h2></div><div class="chart-container" style="height:150px"><canvas id="look-ahead-chart"></canvas></div></div></div></div>
        </div>
    </template>
    
    <template id="template-anomaly-radar">
        <div id="page-anomaly-radar" class="page-content">
            <header class="page-header"><h1>Anomaly & Opportunity Radar</h1><p>Automatically detect, diagnose, and quantify performance shifts.</p></header>
            <div id="anomaly-list-view"><div class="panel"><div class="panel-header"><h2>Detected Events</h2><p style="margin:0;color:var(--atlas-text-secondary)">Showing recent significant deviations from forecast.</p></div><table style="width:100%;border-collapse:collapse"><thead><tr style="text-align:left;border-bottom:1px solid var(--atlas-border-color)"><th style="padding:12px 15px">Date</th><th style="padding:12px 15px">Metric</th><th style="padding:12px 15px">Deviation from Forecast</th><th style="padding:12px 15px">Status</th><th style="padding:12px 15px"></th></tr></thead><tbody id="anomaly-list-container"></tbody></table></div></div>
            <div id="anomaly-detail-view" style="display:none"><div style="margin-bottom:25px"><button id="back-to-list-btn" style="background:none;border:none;color:var(--atlas-text-secondary);padding:5px;font-weight:600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:16px;height:16px;margin-right:5px;vertical-align:text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/></svg> Back to All Events</button></div><div class="grid-2"><div class="panel"><div class="panel-header"><h2>Root Cause Analysis</h2></div><div id="root-cause-tree" class="css-tree"></div></div><div class="panel"><div class="panel-header"><h2>Impact Analysis</h2></div><div class="kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:30px"><div class="kpi-card"><div class="label">Forecasted</div><div id="impact-forecast-value" class="value">-</div></div><div class="kpi-card"><div class="label">Actual</div><div id="impact-actual-value" class="value">-</div></div><div class="kpi-card"><div class="label">Impact</div><div id="impact-delta-value" class="value">-</div></div></div><div class="chart-container" style="height:200px;margin-bottom:30px"><canvas id="impact-chart"></canvas></div><div id="impact-recommendation"></div></div></div></div>
        </div>
    </template>
    
    <template id="template-model-hub">
        <div id="page-model-hub" class="page-content">
            <header class="page-header"><h1>Model Hub</h1><p>Review model details, data sources, and accuracy metrics.</p></header>
            <div class="panel"><div class="panel-header"><h2>Model Atlas v3.1 (Live)</h2></div><p>This model was trained on data from <strong>Jan 1, 2022 to Dec 31, 2023.</strong></p><ul><li><strong>Model Accuracy (R²):</strong> 0.92</li><li><strong>Mean Absolute Percentage Error (MAPE):</strong> 8.1%</li><li><strong>Data Sources Included:</strong> Google Ads, Meta Ads, Nielsen TV Ratings, Internal Sales Data, Economic Indicators (CPI).</li><li><strong>Last Refreshed:</strong> July 1, 2024</li></ul></div>
        </div>
    </template>
    
    <template id="template-settings">
        <div id="page-settings" class="page-content">
             <header class="page-header"><h1>Settings</h1><p>Manage your profile and notification preferences.</p></header>
            <div class="panel"><div class="panel-header"><h2>User Profile</h2></div><label for="userName">Full Name</label><input type="text" id="userName" value="John Appleseed"><label for="userEmail">Email Address</label><input type="text" id="userEmail" value="j.appleseed@examplecorp.com"><button>Save Changes</button></div>
        </div>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===============================================================
        // MASTER STATE & REFERENCES
        // ===============================================================
        const navLinks = document.querySelectorAll('.sidebar nav a[data-target]');
        const mainStage = document.getElementById('main-content-stage');
        const themeToggle = document.getElementById('themeToggle');
        window.atlasCharts = {}; // Global object to hold chart instances

        // ===============================================================
        // THEME LOGIC
        // ===============================================================
        const setAppTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('atlas-theme', theme);
            themeToggle.checked = (theme === 'dark');
            
            // On theme change, reload the current page to redraw charts with new colors
            const activeLink = document.querySelector('.sidebar nav a.active');
            if (activeLink) {
                const targetId = activeLink.getAttribute('data-target').replace('page-', '');
                loadPage(targetId);
            }
        };

        themeToggle.addEventListener('change', () => {
            setAppTheme(themeToggle.checked ? 'dark' : 'light');
        });
        
        // ===============================================================
        // PAGE LOADING & NAVIGATION LOGIC (METHOD 2)
        // ===============================================================
        const loadPage = (pageId) => {
            const template = document.getElementById(`template-${pageId}`);
            if (!template) {
                mainStage.innerHTML = `<p style="color: red;">Error: Template for page "${pageId}" not found.</p>`;
                return;
            }

            // Clear previous content and destroy old charts
            mainStage.innerHTML = '';
            Object.values(window.atlasCharts).forEach(chart => chart.destroy());
            window.atlasCharts = {};
            
            // Clone template and append to the stage
            const content = template.content.cloneNode(true);
            mainStage.appendChild(content);

            // === CRITICAL: Call page-specific JS initializers AFTER content is in the DOM ===
            switch (pageId) {
                case 'command-center':
                    initializeCommandCenter();
                    break;
                case 'dashboard':
                    renderContributionChart();
                    renderRoiTrendChart();
                    break;
                case 'deep-dive':
                    initializeDeepDivePage();
                    break;
                case 'simulator':
                    initializeSimulatorPage();
                    break;
                case 'shapley-analysis':
                    initializeShapleyPage();
                    break;
                case 'granular-reporting':
                    initializeGranularReportingPage();
                    break;
                case 'incrementality':
                    initializeIncrementalityPage();
                    break;
                case 'funnel':
                    initializeFunnelPage();
                    break;
                case 'next-best-move':
                    initializeNextBestMovePage();
                    break;
                case 'anomaly-radar':
                    initializeAnomalyRadarPage();
                    break;
                // 'model-hub' and 'settings' have no JS, so no case is needed.
            }
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');

                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                loadPage(targetId.replace('page-', ''));
            });
        });

        // ===============================================================
        // HELPER FUNCTIONS & SHARED LOGIC
        // ===============================================================
        function getChartColors() {
            const style = getComputedStyle(document.body);
            return {
                gold: style.getPropertyValue('--atlas-gold').trim(),
                textPrimary: style.getPropertyValue('--atlas-text-primary').trim(),
                textSecondary: style.getPropertyValue('--atlas-text-secondary').trim(),
                gridColor: style.getPropertyValue('--atlas-border-color').trim(),
                bgColor: style.getPropertyValue('--atlas-bg-secondary').trim()
            };
        }

        const formatCurrency = (num, dec = 2) => {
            if (!num && num !== 0) return '$0';
            if (num >= 1000000) return `$${(num / 1000000).toFixed(1)}M`;
            if (num >= 1000) return `$${Math.round(num / 1000)}k`;
            return `$${num.toFixed(dec)}`;
        };

        // ===============================================================
        // PAGE-SPECIFIC INITIALIZATION FUNCTIONS
        // ===============================================================

        // --- COMMAND CENTER PAGE ---
// --- NEW COMMAND CENTRE PAGE ---
function initializeCommandCenter() {
    const dataElement = document.getElementById('dashboard-data');
    if (!dataElement) {
        console.error("Dashboard data island not found!");
        return;
    }
    const mockApiData = JSON.parse(dataElement.textContent);
    
    // --- Configuration and Helpers ---
    const METRIC_CONFIG = { cost: { label: 'Spend', format: (v) => formatCurrency(v, 0), isGood: false, category: "Core Performance" }, incremental_conversion_value: { label: 'Incr. Revenue', format: (v) => formatCurrency(v, 0), isGood: true, category: "Core Performance" }, roas: { label: 'ROAS', format: (v) => `${formatNumber(v, 2)}x`, isGood: true, category: "Core Performance" }, incremental_conversions: { label: 'Incr. Conversions', format: (v) => formatNumber(v), isGood: true, category: "Core Performance" }, cpa: { label: 'CPA', format: (v) => `$${formatNumber(v, 2)}`, isGood: false, category: "Core Performance" }, impressions: { label: 'Impressions', format: (v) => formatLargeNumber(v), isGood: true, category: "Key Volumes" }, clicks: { label: 'Clicks', format: (v) => formatLargeNumber(v), isGood: true, category: "Key Volumes" }, video_views: { label: 'Video Views', format: (v) => formatLargeNumber(v), isGood: true, category: "Key Volumes" }, cpm: { label: 'CPM', format: (v) => `$${formatNumber(v, 2)}`, isGood: false, category: "Efficiency" }, cpc: { label: 'CPC', format: (v) => `$${formatNumber(v, 2)}`, isGood: false, category: "Efficiency" }, cpv: { label: 'CPV', format: (v) => formatCurrency(v, 2), isGood: false, category: "Efficiency" }, avgOrderValue: { label: 'Avg. Order Value', format: (v) => formatCurrency(v), isGood: true, category: "Efficiency" }, ctr: { label: 'CTR', format: (v) => formatPercent(v), isGood: true, category: "Engagement" }, cvr: { label: 'CVR', format: (v) => formatPercent(v), isGood: true, category: "Engagement" }, vtr: { label: 'VTR', format: (v) => formatPercent(v), isGood: true, category: "Engagement" } };
    const formatNumber = (val, dec = 0) => val.toLocaleString('en-AU', {minimumFractionDigits: dec, maximumFractionDigits: dec});
    const formatPercent = (val, dec = 2) => `${(val * 100).toFixed(dec)}%`;
    const formatLargeNumber = (num) => { if (Math.abs(num) < 1000) return num.toString(); const item = [{ v: 1e9, s: 'B' }, { v: 1e6, s: 'M' }, { v: 1e3, s: 'k' }].find(i => Math.abs(num) >= i.v); return item ? (num / item.v).toFixed(1).replace(/\.0$/, '') + item.s : num.toString(); };
    const createComparisonHtml = (current, previous, isGood) => { if (previous === null || current === null) return `<span class="change">––</span>`; if (previous === 0) { return current > 0 ? `<span class="change positive">New</span>` : `<span class="change">––</span>`; } const variance = (current - previous) / Math.abs(previous); const trendIsPositive = variance >= 0; const className = trendIsPositive === isGood ? 'positive' : 'negative'; const symbol = trendIsPositive ? '▲' : '▼'; return `<span class="change ${className}">${symbol} ${Math.abs(variance * 100).toFixed(1)}%</span>`; };

    // --- Data Processing Functions ---
    const getFilteredData = (data, startDateStr, endDateStr, region) => { const start = new Date(startDateStr + 'T00:00:00'); const end = new Date(endDateStr + 'T00:00:00'); end.setHours(23, 59, 59, 999); const isRegionFiltered = region !== 'All'; return data.filter(d => { const itemDate = new Date(d.date + 'T00:00:00'); const inDateRange = itemDate >= start && itemDate <= end; const inRegion = isRegionFiltered ? d.grouping_key === region : true; return inDateRange && inRegion; }); };
    const calculateAggregateMetrics = (data) => { if (!data || data.length === 0) return null; const totals = data.reduce((acc, row) => { Object.keys(acc).forEach(key => { if (typeof row[key] === 'number') acc[key] += row[key]; }); acc.recommendation_scale_sum += (row.recommendation_scale * row.cost); return acc; }, { cost: 0, impressions: 0, clicks: 0, video_views: 0, incremental_conversions: 0, incremental_conversion_value: 0, recommendation_scale_sum: 0 }); return { cost: totals.cost, impressions: totals.impressions, clicks: totals.clicks, video_views: totals.video_views, incremental_conversions: totals.incremental_conversions, incremental_conversion_value: totals.incremental_conversion_value, roas: totals.cost > 0 ? totals.incremental_conversion_value / totals.cost : 0, optimisationScore: totals.cost > 0 ? (totals.recommendation_scale_sum / totals.cost) : 0, cpc: totals.clicks > 0 ? totals.cost / totals.clicks : 0, cpm: totals.impressions > 0 ? (totals.cost / totals.impressions) * 1000 : 0, cpv: totals.video_views > 0 ? totals.cost / totals.video_views : 0, cpa: totals.incremental_conversions > 0 ? totals.cost / totals.incremental_conversions : 0, ctr: totals.impressions > 0 ? (totals.clicks / totals.impressions) : 0, cvr: totals.clicks > 0 ? (totals.incremental_conversions / totals.clicks) : 0, vtr: totals.impressions > 0 ? (totals.video_views / totals.impressions) : 0, avgOrderValue: totals.incremental_conversions > 0 ? totals.incremental_conversion_value / totals.incremental_conversions : 0, }; };
    const createChannelSummary = (data) => { const channelMap = new Map(); data.forEach(row => { if (!channelMap.has(row.channel)) { channelMap.set(row.channel, { cost: 0, incremental_conversion_value: 0, recommendation_scale_sum: 0, revenue_contribution: 0 }); } const current = channelMap.get(row.channel); current.cost += row.cost; current.incremental_conversion_value += row.incremental_conversion_value; current.recommendation_scale_sum += row.recommendation_scale * row.cost; }); const totalRevenue = Array.from(channelMap.values()).reduce((sum, v) => sum + v.incremental_conversion_value, 0); return Array.from(channelMap.entries()).map(([channel, metrics]) => ({ channel, cost: metrics.cost, roas: metrics.cost > 0 ? metrics.incremental_conversion_value / metrics.cost : 0, headroom: metrics.cost > 0 ? (metrics.recommendation_scale_sum / metrics.cost) : 0, revenue_contribution: totalRevenue > 0 ? metrics.incremental_conversion_value / totalRevenue : 0 })); };
    const generateStrategicInsights = (channelSummary) => { if (!channelSummary || channelSummary.length === 0) return { recommendations: [], drivers: [] }; const maxRoas = Math.max(...channelSummary.map(c => c.roas), 1); const minRoas = Math.min(...channelSummary.map(c => c.roas)); const scored = channelSummary.map(c => { const normRoas = maxRoas > minRoas ? (c.roas - minRoas) / (maxRoas - minRoas) : 0; const headroomScore = Math.max(0, (c.headroom - 0.8) / 0.25); const increaseScore = (1 + Math.log1p(normRoas)) * (1 + headroomScore); const clampedHeadroom = Math.max(0, Math.min(1, headroomScore)); const decreaseScore = (1 + Math.log1p(1 - normRoas)) * (1 + (1 - clampedHeadroom)); return { ...c, increaseScore, decreaseScore }; }); const topIncrease = [...scored].sort((a,b)=>b.increaseScore-a.increaseScore).slice(0,4).map(c => ({ type: 'increase', detail: `Scale ${c.channel}`, text: `Strong ROAS (${c.roas.toFixed(2)}x) with headroom.` })); const topDecrease = [...scored].filter(c=>c.roas < 2).sort((a,b)=>b.decreaseScore-a.decreaseScore).slice(0,3).map(c => ({ type: 'decrease', detail: `Reduce ${c.channel} Spend`, text: `Inefficient relative to peers; consider reallocating.` })); const topOpp = [...scored].filter(c=>c.revenue_contribution < 0.2 && c.roas > 2).sort((a,b)=>b.roas-a.roas).slice(0,3).map(c => ({ type: 'opportunity', detail: `Explore Growth in ${c.channel}`, text: `High ROAS (${c.roas.toFixed(2)}x) on low share.` })); const seen = new Set(); const recommendations = [...topIncrease, ...topOpp, ...topDecrease].filter(r=>{ const key = r.detail.replace(/^(Scale|Reduce|Explore Growth in)\s+/,''); if (seen.has(key)) return false; seen.add(key); return true; }).slice(0, 6); const drivers = [...scored].sort((a,b)=>b.roas-a.roas).slice(0,2).map(d=>({isPositive: true, text: `${d.channel} is a strong efficiency driver`})).concat([...scored].sort((a,b)=>a.roas-b.roas).slice(0,2).map(d=>({isPositive: false, text: `${d.channel} is underperforming on ROAS`}))); return { recommendations, drivers }; };

    // --- Rendering Functions ---
    const renderKpiCards = (metrics, prevMetrics) => { const container = document.getElementById('kpi-cards-container'); if (!metrics) { container.innerHTML = `<div class="kpi-card" style="grid-column: 1 / -1;"><div class="label">No data for selected period.</div></div>`; return; } const os = metrics.optimisationScore > 0 ? Math.max(0.5, Math.min(1.5, metrics.optimisationScore)) : 0; const potentialValue = os > 0 ? metrics.incremental_conversion_value * ((1 / os) - 1) : 0; container.innerHTML = `<div class="kpi-card"><div class="label">Total Marketing ROI</div><div class="value">${METRIC_CONFIG.roas.format(metrics.roas)}</div><div class="change">${createComparisonHtml(metrics.roas, prevMetrics?.roas, METRIC_CONFIG.roas.isGood)} vs prev. period</div></div><div class="kpi-card"><div class="label">Total Incremental Revenue</div><div class="value">${METRIC_CONFIG.incremental_conversion_value.format(metrics.incremental_conversion_value)}</div><div class="change">${createComparisonHtml(metrics.incremental_conversion_value, prevMetrics?.incremental_conversion_value, METRIC_CONFIG.incremental_conversion_value.isGood)} vs prev. period</div></div><div class="kpi-card"><div class="label">Optimisation Score</div><div class="value">${formatPercent(metrics.optimisationScore, 0)}</div><div class="change">${createComparisonHtml(metrics.optimisationScore, prevMetrics?.optimisationScore, true)}<span style="display: block; color: var(--atlas-text-secondary); font-weight: 400; font-size: 0.9em; margin-top: 4px;">Potential: +${formatCurrency(Math.max(0, potentialValue))}</span></div></div>`; };
    const renderStrategicInsights = (insights) => { const recContainer = document.getElementById('recommendations-container'); const driverContainer = document.getElementById('drivers-container'); driverContainer.setAttribute('aria-busy', 'false'); if (insights.recommendations.length === 0) { recContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align:center; color: var(--atlas-text-secondary);">Insufficient data for recommendations.</p>`; } else { const createRecHtml = (rec) => `<div class="recommendation-card"><div class="icon">${{increase: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>`, decrease: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/></svg>`, opportunity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg>`}[rec.type]}</div><div><h3>${rec.detail}</h3><p>${rec.text}</p></div></div>`; const allRecs = insights.recommendations, visibleRecs = allRecs.slice(0, 3), hiddenRecs = allRecs.slice(3); let html = visibleRecs.map(createRecHtml).join(''); if (hiddenRecs.length > 0) { html += `<div id="hidden-recs-wrapper" style="display: none; grid-column: 1 / -1; margin-top: 25px;"><div class="grid-3" style="margin-bottom: 0;">${hiddenRecs.map(createRecHtml).join('')}</div></div>`; html += `<div style="grid-column: 1 / -1; text-align: center; margin-top: 20px;"><button type="button" id="toggle-recs-btn" class="toggle-recs-button" aria-expanded="false">Show ${hiddenRecs.length} more...</button></div>`; } recContainer.innerHTML = html; if (hiddenRecs.length > 0) { const btn = document.getElementById('toggle-recs-btn'), wrapper = document.getElementById('hidden-recs-wrapper'); btn.addEventListener('click', (e) => { e.preventDefault(); const isHidden = wrapper.style.display === 'none'; wrapper.style.display = isHidden ? 'block' : 'none'; btn.textContent = isHidden ? 'Show less' : `Show ${hiddenRecs.length} more...`; btn.setAttribute('aria-expanded', isHidden); }); } } if (insights.drivers.length === 0) { driverContainer.innerHTML = `<li style="color: var(--atlas-text-secondary);">No significant drivers identified.</li>`; } else { driverContainer.innerHTML = insights.drivers.map(d => `<li class="${d.isPositive ? 'positive' : 'negative'}"><div class="icon">${d.isPositive ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" /></svg>`}</div> ${d.text}</li>`).join(''); } };
    const renderPerformanceSnapshot = (metrics, prevMetrics) => { const container = document.getElementById('performance-snapshot-container'); if (!metrics) { container.innerHTML = `<p style="text-align:center; color: var(--atlas-text-secondary);">No data available.</p>`; return; } const groupedMetrics = Object.entries(METRIC_CONFIG).reduce((acc, [key, config]) => { if (!acc[config.category]) acc[config.category] = ''; acc[config.category] += `<div class="snapshot-card"><div class="label">${config.label}</div><div class="value">${config.format(metrics[key])}</div><div class="change">${createComparisonHtml(metrics[key], prevMetrics?.[key], config.isGood)}</div></div>`; return acc; }, {}); container.innerHTML = Object.entries(groupedMetrics).map(([category, cards]) => `<div class="snapshot-group"><h3 class="snapshot-group-title">${category}</h3><div class="snapshot-grid">${cards}</div></div>`).join(''); };
    const renderTrendChart = (data, metricKey) => { const ctx = document.getElementById('revenueTrendChart')?.getContext('2d'); if(!ctx) return; const colors = getChartColors(); const config = METRIC_CONFIG[metricKey] || { label: 'Revenue', format: (v) => `$${formatLargeNumber(v)}` }; document.getElementById('trend-chart-title').textContent = `${config.label} Trend`; const aggregated = data.reduce((map, row) => { if (!map.has(row.date)) map.set(row.date, { cost: 0, incremental_conversion_value: 0, incremental_conversions: 0, impressions: 0, clicks: 0, video_views: 0 }); const day = map.get(row.date); day.cost += row.cost; day.incremental_conversion_value += row.incremental_conversion_value; day.incremental_conversions += row.incremental_conversions; day.impressions += row.impressions; day.clicks += row.clicks; day.video_views += row.video_views; return map; }, new Map()); const sortedLabels = [...aggregated.keys()].sort((a,b) => new Date(a) - new Date(b)); const chartValues = sortedLabels.map(date => { const d = aggregated.get(date); switch (metricKey) { case 'roas': return d.cost > 0 ? d.incremental_conversion_value / d.cost : 0; case 'cpa':  return d.incremental_conversions > 0 ? d.cost / d.incremental_conversions : 0; case 'ctr':  return d.impressions > 0 ? d.clicks / d.impressions : 0; case 'cvr':  return d.clicks > 0 ? d.incremental_conversions / d.clicks : 0; case 'vtr':  return d.impressions > 0 ? d.video_views / d.impressions : 0; default: return d[metricKey] ?? 0; } }); window.atlasCharts.trendChart = new Chart(ctx, { type: 'line', data: { labels: sortedLabels, datasets: [{ label: config.label, data: chartValues, borderColor: colors.gold, backgroundColor: colors.gold + '33', borderWidth: 2, pointRadius: 1, tension: 0.3, fill: true, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: colors.text, callback: (v) => { if (['ctr', 'cvr', 'vtr'].includes(metricKey)) return formatPercent(v, 0); if (metricKey === 'roas') return `${v.toFixed(1)}x`; if (['cost', 'incremental_conversion_value', 'cpa'].includes(metricKey)) return formatCurrency(v, 0).replace(/\.\d+$/, ''); return formatLargeNumber(v); } }, grid: { color: colors.grid } }, x: { type: 'time', time: { unit: 'day' }, ticks: { color: colors.text }, grid: { display: false } } } } }); };
    const renderChannelRoiChart = (channelSummary) => { const ctx=document.getElementById('channelRoiChart')?.getContext('2d'); if(!ctx) return; const colors = getChartColors(); const sortedData = [...channelSummary].sort((a,b) => b.roas - a.roas).slice(0, 5); window.atlasCharts.channelRoi=new Chart(ctx,{ type:'bar', data:{ labels:sortedData.map(d=>d.channel), datasets:[{ label:'ROI', data:sortedData.map(d=>d.roas), backgroundColor:colors.gold }] }, options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true, grid:{ color:colors.grid }, ticks:{ color:colors.text, callback:(v)=>`${v}x` } }, y:{ grid:{ display:false }, ticks:{ color:colors.text } } } } }); };

    // --- Main Update & Initialization Logic ---
    const { subDays, format, differenceInDays } = window.dateFns;
    const UI = { startDateFilter: document.getElementById('start-date-filter'), endDateFilter: document.getElementById('end-date-filter'), regionFilter: document.getElementById('region-filter'), trendMetricSelect: document.getElementById('trend-metric-select'), driversContainer: document.getElementById('drivers-container') };

    function updateDashboard() {
        const { value: startDate } = UI.startDateFilter, { value: endDate } = UI.endDateFilter;
        const { value: region } = UI.regionFilter, { value: trendMetric } = UI.trendMetricSelect;
        const currentData = getFilteredData(mockApiData, startDate, endDate, region);
        const currentMetrics = calculateAggregateMetrics(currentData);
        const channelSummary = createChannelSummary(currentData);
        const dateDiff = differenceInDays(new Date(endDate), new Date(startDate)) + 1;
        const prevEndDate = subDays(new Date(startDate), 1);
        const prevStartDate = subDays(prevEndDate, dateDiff - 1);
        const prevData = getFilteredData(mockApiData, format(prevStartDate, 'yyyy-MM-dd'), format(prevEndDate, 'yyyy-MM-dd'), region);
        const prevMetrics = calculateAggregateMetrics(prevData);
        const insights = generateStrategicInsights(channelSummary);
        renderKpiCards(currentMetrics, prevMetrics);
        renderStrategicInsights(insights);
        renderPerformanceSnapshot(currentMetrics, prevMetrics);
        renderTrendChart(currentData, trendMetric);
        renderChannelRoiChart(channelSummary);
    }
    
    function updateTrendChartOnly() {
        if(window.atlasCharts.trendChart) window.atlasCharts.trendChart.destroy();
        const { value: startDate } = UI.startDateFilter, { value: endDate } = UI.endDateFilter;
        const { value: region } = UI.regionFilter, { value: trendMetric } = UI.trendMetricSelect;
        const currentData = getFilteredData(mockApiData, startDate, endDate, region);
        renderTrendChart(currentData, trendMetric);
    }
    
    // Initialize page listeners and state
    const regions = ['All', ...new Set(mockApiData.map(d => d.grouping_key))];
    UI.regionFilter.innerHTML = regions.map(r => `<option value="${r}">${r}</option>`).join('');
    const today = new Date();
    UI.endDateFilter.value = format(today, 'yyyy-MM-dd');
    UI.startDateFilter.value = format(subDays(today, 29), 'yyyy-MM-dd');
    UI.driversContainer.innerHTML = `<li class="loading-overlay" style="display:block; list-style: none; text-align: left; padding: 20px 0;">Identifying key drivers...</li>`;
    const setDateConstraints = () => { UI.endDateFilter.min = UI.startDateFilter.value; UI.startDateFilter.max = UI.endDateFilter.value; };
    setDateConstraints();
    [UI.startDateFilter, UI.endDateFilter, UI.regionFilter].forEach(el => el.addEventListener('change', () => { setDateConstraints(); updateDashboard(); }));
    UI.trendMetricSelect.addEventListener('change', updateTrendChartOnly);
    updateDashboard(); // Initial render
}
        // --- DASHBOARD PAGE ---
        function renderContributionChart() {
            const ctx = document.getElementById('contributionChart')?.getContext('2d');
            if (!ctx) return;
            const colors = getChartColors();
            window.atlasCharts.contribution = new Chart(ctx, { type: 'doughnut', data: { labels: ['Paid Search', 'Paid Social', 'TV', 'Sponsorships', 'Out of Home', 'Base'], datasets: [{ data: [4200000, 2800000, 1500000, 800000, 400000, 3000000], backgroundColor: [colors.gold, '#4A5B70', '#74869D', '#A9B4C2', '#D2D8DE', 'rgba(0,0,0,0.1)'], borderColor: colors.bgColor, borderWidth: 4, }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { color: colors.textSecondary, font: { weight: '600' } } }, title: { display: false } } } });
        }
        function renderRoiTrendChart() {
            const ctx = document.getElementById('roiTrendChart')?.getContext('2d');
            if (!ctx) return;
            const colors = getChartColors();
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, `${colors.gold}80`);
            gradient.addColorStop(1, `${colors.gold}00`);
            window.atlasCharts.roiTrend = new Chart(ctx, { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Overall ROI', data: [3.8, 3.9, 4.3, 4.1, 4.4, 4.2], borderColor: colors.gold, borderWidth: 3, pointBackgroundColor: colors.gold, pointRadius: 4, tension: 0.4, fill: true, backgroundColor: gradient, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false, ticks: { color: colors.textSecondary }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textSecondary }, grid: { color: colors.gridColor } } } } });
        }

        // --- DEEP DIVE PAGE ---
        function initializeDeepDivePage() {
            const deepDiveData = { 'Paid Search': { roi: 5.89, revenue: 4200000, spend: 713000, saturation: 85 }, 'Paid Social': { roi: 5.09, revenue: 2800000, spend: 550000, saturation: 90 }, 'TV': { roi: 1.36, revenue: 1500000, spend: 1100000, saturation: 65 }, 'Out of Home': { roi: 1.15, revenue: 400000, spend: 347000, saturation: 50 }, 'Sponsorships': { roi: 2.67, revenue: 800000, spend: 300000, saturation: 75 } };
            const channelSelector = document.getElementById('channel-selector');
            const updateDeepDiveView = (channelName) => {
                const data = deepDiveData[channelName];
                if (!data) return;
                document.getElementById('performance-panel-title').innerHTML = `${channelName}: Performance<small>Key metrics for the selected channel</small>`;
                document.getElementById('response-curve-panel-title').innerHTML = `${channelName}: Response Curve<small>Diminishing returns based on spend level</small>`;
                document.getElementById('kpi-roi-value').textContent = `${data.roi.toFixed(2)}x`;
                document.getElementById('kpi-revenue-value').textContent = formatCurrency(data.revenue);
                document.getElementById('kpi-spend-value').textContent = formatCurrency(data.spend);
                document.getElementById('kpi-saturation-value').textContent = `~${data.saturation}%`;
                renderResponseCurveChart();
            };
            if (channelSelector) {
                channelSelector.addEventListener('change', (event) => updateDeepDiveView(event.target.value));
                updateDeepDiveView(channelSelector.value); // Initial render
            }
        }
        function renderResponseCurveChart() {
            const ctx = document.getElementById('responseCurveChart')?.getContext('2d');
            if (!ctx) return;
            const colors = getChartColors();
            const spend = Array.from({length: 21}, (_, i) => i * 50000);
            const revenue = spend.map(s => Math.log(s + 1) * 900000);
            window.atlasCharts.responseCurve = new Chart(ctx, { type: 'line', data: { labels: spend, datasets: [{ label: 'Attributed Revenue', data: revenue, borderColor: colors.gold, borderWidth: 3, tension: 0.4, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { title: { display: true, text: 'Attributed Revenue', color: colors.textSecondary }, ticks: { color: colors.textSecondary, callback: (val) => `$${(val/1000000).toFixed(1)}M`}, grid: { color: colors.gridColor } }, x: { title: { display: true, text: 'Spend', color: colors.textSecondary }, ticks: { color: colors.textSecondary, callback: function(value) { const labelValue = this.getLabelForValue(value); if (value % 2 === 0) { return `$${(labelValue / 1000).toFixed(0)}k`; } } }, grid: { display: false } } } } });
        }

        // --- SIMULATOR PAGE ---
function initializeSimulatorPage() {
    // --- HOLISTIC SEASONALITY MODULE ---
    const seasonality = (() => {
        let doyIndex = {};
        let dowIndex = {};

        function parseSeasonalityJSON() {
            const dataElement = document.getElementById('seasonalityData');
            if (!dataElement) {
                console.log("Seasonality: #seasonalityData element not found. Proceeding without seasonality.");
                return;
            }
            try {
                const rawData = JSON.parse(dataElement.textContent);
                if (!Array.isArray(rawData)) return;
                const DOW_NAMES = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                for (const row of rawData) {
                    const key = row.grouping_key;
                    const type = row.seasonality_type;
                    const factor = (typeof row.conversion_value_seasonality_index === 'number' && row.conversion_value_seasonality_index > 0) ? row.conversion_value_seasonality_index : 1.0;
                    if (!key || !type) continue;
                    if (type === 'DOY') {
                        if (!doyIndex[key]) doyIndex[key] = {};
                        const day = parseInt(row.index, 10);
                        if (Number.isInteger(day) && day >= 1 && day <= 365) doyIndex[key][day] = factor;
                    } else if (type === 'DOW') {
                        if (!dowIndex[key]) dowIndex[key] = {};
                        if (typeof row.index === 'string' && DOW_NAMES.includes(row.index)) dowIndex[key][row.index] = factor;
                    }
                }
            } catch (error) {
                console.error("Seasonality: Failed to parse JSON data.", error);
            }
        }
        const isLeapYear = (year) => (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
        const getDayOfYearNormalized = (date) => {
            const start = new Date(date.getFullYear(), 0, 0);
            let doy = Math.floor((date.getTime() - start.getTime()) / 86400000);
            if (isLeapYear(date.getFullYear()) && date.getMonth() > 1) doy -= 1;
            return doy;
        };
        const DOW_NAMES = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const getDowName = (date) => DOW_NAMES[date.getDay()];
        const getSeasonalityFactor = (date, groupingKey) => {
            if (!doyIndex[groupingKey] && !dowIndex[groupingKey]) return 1.0;
            const doyFactor = doyIndex[groupingKey]?.[getDayOfYearNormalized(date)] ?? 1.0;
            const dowFactor = dowIndex[groupingKey]?.[getDowName(date)] ?? 1.0;
            return (doyFactor + dowFactor) / 2.0;
        };
        const getAverageFactorForPeriod = (startDateStr, endDateStr, groupingKey) => {
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || endDate < startDate) return 1.0;
            let totalFactor = 0, dayCount = 0;
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                totalFactor += getSeasonalityFactor(currentDate, groupingKey);
                dayCount++;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dayCount > 0 ? totalFactor / dayCount : 1.0;
        };
        return { init: parseSeasonalityJSON, getAverageFactor: getAverageFactorForPeriod };
    })();

    async function findOptimalBudgets({ channelData, revenueTarget, budgetConstraint = null, initialBudgets, numberOfDays, startDate, endDate, groupingKey, progressCallback }) {
        const avgSeasonalityFactor = seasonality.getAverageFactor(startDate, endDate, groupingKey);
        const orderedChannels = Object.keys(channelData);
        const EPS = 1e-6;
        const fin = x => (Number.isFinite(+x) ? +x : 0);
        const modelTypeMap = { "Piecewise": 0, "Quadratic": 1, "Logarithmic": 2, "Power": 3, "SCurve": 4, "Exponential": 5, "Linear": 6, "Inverse": 7 };
        const dailyBounds = orderedChannels.map(ch => {
            const s = channelData[ch], mu = fin(s.avg_spend), sd = Math.max(0, fin(s.spend_std_dev)), maxDaily = Number.isFinite(+s.max_daily_spend) ? +s.max_daily_spend : Infinity;
            const lowerDaily = Math.max(0, mu - 1 * sd), softCapDaily = Number.isFinite(maxDaily) ? maxDaily : (mu + 6 * (sd || Math.max(1, mu * 0.25))), upperDaily = Math.min(mu + 2.5 * sd, softCapDaily);
            const lower = Math.max(0, lowerDaily) * numberOfDays, upper = Math.max(lower + 1e-3, upperDaily * numberOfDays);
            return { lower, upper };
        });
        const widths = dailyBounds.map(b => b.upper - b.lower);
        const initialSig = orderedChannels.map((ch, i) => {
            const b = Math.max(0, fin(initialBudgets[ch])), clamped = Math.min(Math.max(b, dailyBounds[i].lower), dailyBounds[i].upper);
            const t = (clamped - dailyBounds[i].lower) / (widths[i] || 1), clipped = Math.min(1 - 1e-6, Math.max(1e-6, t));
            return Math.log(clipped / (1 - clipped));
        });
        const rawVars = tf.variable(tf.tensor1d(initialSig, 'float32'));
        const params = {
            modelTypeIndex: tf.tensor1d(orderedChannels.map(ch => modelTypeMap[channelData[ch].model_name] ?? -1), 'int32'),
            agg: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].aggregation_level_value) || 1), 'float32'),
            p1: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].p1_value)), 'float32'), p2: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].p2_value)), 'float32'), p3: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].p3_value)), 'float32'),
            p4: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].p4_value)), 'float32'), p5: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].p5_value)), 'float32'),
            lower: tf.tensor1d(dailyBounds.map(b => b.lower), 'float32'), upper: tf.tensor1d(dailyBounds.map(b => b.upper), 'float32'),
            muDaily: tf.tensor1d(orderedChannels.map(ch => fin(channelData[ch].avg_spend)), 'float32'), sdDaily: tf.tensor1d(orderedChannels.map(ch => Math.max(EPS, fin(channelData[ch].spend_std_dev))), 'float32'),
            w: tf.tensor1d(orderedChannels.map(ch => (fin(channelData[ch].r_squared_value)) * (fin(channelData[ch].significance_weight) || 1)), 'float32'),
            width: tf.tensor1d(widths, 'float32')
        };
        const wSum = params.w.sum();
        const evaluateSpends = (periodSpends) => tf.tidy(() => {
            const p = params, xRaw = periodSpends.div(numberOfDays).add(EPS).mul(p.agg), x = xRaw.clipByValue(EPS, 1e7);
            const safeLog = t => tf.log(t.clipByValue(EPS, 1e12)), safeRecip = t => tf.reciprocal(t.clipByValue(EPS, 1e12)), safePow = (base, exp) => tf.pow(base.clipByValue(EPS, 1e6), exp.clipByValue(-6, 6));
            const wSwitch = tf.sigmoid(x.sub(p.p1).mul(25)), piecewiseRev = p.p2.add(p.p3.mul(x)).mul(tf.scalar(1).sub(wSwitch)).add(p.p4.add(p.p5.mul(x)).mul(wSwitch));
            const quadExp = tf.where(tf.isFinite(p.p4), p.p4, tf.scalar(2, 'float32')), quadraticRev = p.p1.add(p.p2.mul(x)).add(p.p3.mul(safePow(x, quadExp)));
            const logRev = p.p1.add(p.p2.mul(safeLog(x))), powerRev = tf.relu(p.p1).mul(safePow(x, p.p2));
            const sCurveRev = tf.relu(p.p1).mul(tf.sigmoid(p.p3.mul(x.sub(p.p4)).neg()));
            const expRev = tf.relu(p.p1).mul(tf.exp(p.p2.mul(x).clipByValue(-30, 30)));
            const linearRev = p.p1.add(p.p2.mul(x)), inverseRev = p.p1.add(p.p2.mul(p.p3.mul(safeRecip(x))));
            let onModel = tf.zerosLike(x);
            onModel = tf.where(p.modelTypeIndex.equal(0), piecewiseRev, onModel); onModel = tf.where(p.modelTypeIndex.equal(1), quadraticRev, onModel); onModel = tf.where(p.modelTypeIndex.equal(2), logRev, onModel); onModel = tf.where(p.modelTypeIndex.equal(3), powerRev, onModel);
            onModel = tf.where(p.modelTypeIndex.equal(4), sCurveRev, onModel); onModel = tf.where(p.modelTypeIndex.equal(5), expRev, onModel); onModel = tf.where(p.modelTypeIndex.equal(6), linearRev, onModel); onModel = tf.where(p.modelTypeIndex.equal(7), inverseRev, onModel);
            const periodRev = onModel.relu().clipByValue(0, 1e12).div(p.agg).mul(numberOfDays);
            const unadjustedTotalRevM = periodRev.mul(p.w).sum().div(wSum.add(EPS)).div(1e6);
            const totalSpendM = periodSpends.sum().div(1e6).add(EPS);
            const totalRevM = unadjustedTotalRevM.mul(tf.scalar(avgSeasonalityFactor, 'float32'));
            const roi = totalRevM.div(totalSpendM);
            return { totalRevM, totalSpendM, roi };
        });
        const opt = tf.train.adam(0.001, 0.9, 0.999, 1e-8);
        const targetM = tf.scalar(revenueTarget / 1e6, 'float32');
        for (let i = 0; i < 5000; i++) {
            const { value: loss, grads } = tf.variableGrads(() => tf.tidy(() => {
                const periodSpends = params.lower.add(params.width.mul(tf.sigmoid(rawVars)));
                const { totalRevM, totalSpendM, roi } = evaluateSpends(periodSpends);
                const errorM = totalRevM.sub(targetM), delta = tf.scalar(0.05);
                const pseudoHuber = delta.square().mul(errorM.div(delta).square().add(1).sqrt().sub(1));
                const targetPenalty = pseudoHuber.mul(15000 * Math.max(1, (revenueTarget / 1e7)));
                const gate = tf.scalar(0.25).sub(errorM.abs()).div(0.02).mul(12).sigmoid();
                const roiTieBreak = roi.neg().mul(gate);
                const spendEfficiencyPenalty = totalSpendM.mul(500);
                let budgetPenalty = tf.scalar(0, 'float32');
                if (budgetConstraint != null && Number.isFinite(budgetConstraint) && budgetConstraint > 0) {
                    const budgetExceededM = tf.relu(totalSpendM.sub(budgetConstraint / 1e6));
                    budgetPenalty = budgetExceededM.square().mul(90000);
                }
                const L = targetPenalty.add(roiTieBreak).add(spendEfficiencyPenalty).add(budgetPenalty);
                return tf.where(L.isFinite(), L, tf.scalar(1e8, 'float32'));
            }), [rawVars]);
            const g = grads[rawVars.name], clippedG = tf.tidy(() => g.mul(tf.minimum(1, tf.scalar(1.0).div(tf.sqrt(g.square().sum()).add(EPS)))));
            opt.applyGradients({ [rawVars.name]: clippedG });
            tf.tidy(() => rawVars.assign(tf.where(rawVars.isFinite(), rawVars, tf.zerosLike(rawVars)).clipByValue(-10, 10)));
            if (typeof progressCallback === 'function' && ((i + 1) % 20 === 0)) progressCallback({ iteration: i + 1, totalIterations: 5000, loss: (await loss.data())[0].toExponential(6) });
            loss.dispose(); g.dispose(); clippedG.dispose();
        }
        const finalSpends = await tf.tidy(() => params.lower.add(params.width.mul(tf.sigmoid(rawVars)))).array();
        rawVars.dispose(); Object.values(params).forEach(t => t.dispose()); wSum.dispose(); opt.dispose();
        if (progressCallback) progressCallback({ iteration: 5000, totalIterations: 5000, loss: 'complete' });
        const out = {};
        orderedChannels.forEach((ch, i) => { out[ch] = Math.round(Math.min(Math.max(finalSpends[i], dailyBounds[i].lower), dailyBounds[i].upper)); });
        return out;
    }

    // --- MAIN SCRIPT LOGIC ---
    seasonality.init();
    const channelModelData = JSON.parse(document.getElementById('channelData').textContent).reduce((acc, item) => { acc[item.channel] = item; return acc; }, {});
    const seasonalityDataJSON = JSON.parse(document.getElementById('seasonalityData').textContent);
    const allocatorContainer = document.getElementById('budget-allocator'), startDateInput = document.getElementById('startDate'), endDateInput = document.getElementById('endDate'), durationDisplay = document.getElementById('sim-duration'),
        groupingKeySelect = document.getElementById('groupingKeySelect'), channelSelectContainer = document.getElementById('channelSelectContainer'), channelSelectDisplay = document.getElementById('channelSelectDisplay'), channelSelectDropdown = document.getElementById('channelSelectDropdown');
    
    let initialBudgets = {}, currentBudgets = {}, optimalSpendByChannel = null, initialTotal = 0, warningCheckers = {}, selectedChannels = [];

    const calculateDays = (start, end) => start && end ? (Math.round((new Date(end) - new Date(start)) / 86400000) + 1) : 0;
    
    const evaluateSingleChannelRevenue = (channel, periodSpend) => {
        const model = channelModelData[channel], days = calculateDays(startDateInput.value, endDateInput.value);
        if (!model || days <= 0) return 0;
        const x = ((periodSpend / days) * (model.aggregation_level_value || 1)) || 1e-9;
        let rev;
        switch (model.model_name) {
            case "Piecewise": rev = x < model.p1_value ? model.p2_value + model.p3_value * x : model.p4_value + (model.p5_value ?? 0) * x; break;
            case "Quadratic": rev = model.p1_value + (model.p2_value * x) + (model.p3_value * Math.pow(x, Number.isFinite(model.p4_value) ? model.p4_value : 2)); break;
            case "Logarithmic": rev = model.p1_value + model.p2_value * Math.log(x); break;
            case "Power": rev = Math.max(0, model.p1_value) * Math.pow(x, model.p2_value); break;
            case "SCurve": rev = Math.max(0, model.p1_value) / ((model.p2_value ?? 1) + Math.exp(model.p3_value * (x - model.p4_value))); break;
            case "Exponential": rev = Math.max(0, model.p1_value) * Math.exp(Math.min(30, model.p2_value * x)); break;
            case "Linear": rev = model.p1_value + model.p2_value * x; break;
            case "Inverse": rev = model.p1_value + model.p2_value * ((model.p3_value ?? 1) / x); break;
            default: rev = 0;
        }
        return (Math.max(0, rev) / (model.aggregation_level_value || 1)) * days;
    };
    
    const updateSimulation = () => {
        const newTotalSpend = Object.values(currentBudgets).reduce((a, b) => a + b, 0);
        document.getElementById('totalBudgetDisplay').textContent = `$${Math.round(newTotalSpend).toLocaleString()}`;
        let weightedRevenueSum = 0, totalWeightSum = 0;
        Object.entries(currentBudgets).forEach(([ch, spend]) => {
            const model = channelModelData[ch];
            if (!model) return;
            const revenue = evaluateSingleChannelRevenue(ch, spend);
            const weight = model.r_squared_value * model.significance_weight;
            weightedRevenueSum += revenue * weight;
            totalWeightSum += weight;
        });
        const unadjustedRevenue = totalWeightSum > 0 ? (weightedRevenueSum / totalWeightSum) : 0;
        const seasonalFactor = seasonality.getAverageFactor(startDateInput.value, endDateInput.value, groupingKeySelect.value);
        const totalRevenue = unadjustedRevenue * seasonalFactor;
        document.getElementById('sim-revenue').textContent = `$${(totalRevenue / 1e6).toFixed(2)}M`;
        document.getElementById('sim-roi').textContent = `${(newTotalSpend > 0 ? totalRevenue / newTotalSpend : 0).toFixed(2)}x`;
        document.getElementById('sim-spend-change').textContent = `$${Math.round(newTotalSpend - initialTotal).toLocaleString('en-US', { signDisplay: 'auto' })}`;
    };

    const buildSimulator = () => {
        const days = calculateDays(startDateInput.value, endDateInput.value);
        durationDisplay.textContent = `${days} Day${days !== 1 ? 's' : ''}`;
        allocatorContainer.innerHTML = '';
        initialBudgets = {}; currentBudgets = {}; warningCheckers = {}; optimalSpendByChannel = null;
        selectedChannels.forEach(channel => {
            const data = channelModelData[channel];
            if (!data) return;
            const budget = Math.round(data.avg_spend * days);
            initialBudgets[channel] = budget;
            const safeId = channel.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
            const row = document.createElement('div');
            row.className = 'simulator-grid';
            row.innerHTML = `<label for="${safeId}-slider">${channel}</label><div><input type="range" id="${safeId}-slider" data-channel="${channel}" min="0" max="${Math.round(budget * 3)}" value="${budget}" step="100"></div><div class="budget-value-wrapper"><span class="budget-value" id="${safeId}-value">$${budget.toLocaleString()}</span><span class="warning-icon" id="${safeId}-warning" title="Spend exceeds typical levels. Projections may be less accurate.">⚠️</span></div>`;
            allocatorContainer.appendChild(row);
            const slider = row.querySelector(`#${safeId}-slider`), valueDisplay = row.querySelector(`#${safeId}-value`), warningIcon = row.querySelector(`#${safeId}-warning`);
            warningCheckers[channel] = () => { warningIcon.style.display = (parseInt(slider.value) > (data.avg_spend + 2.5 * data.spend_std_dev) * days) ? 'inline-block' : 'none'; };
            slider.addEventListener('input', () => { currentBudgets[channel] = parseInt(slider.value); valueDisplay.textContent = `$${currentBudgets[channel].toLocaleString()}`; warningCheckers[channel](); updateSimulation(); });
            warningCheckers[channel]();
        });
        currentBudgets = { ...initialBudgets };
        initialTotal = Object.values(initialBudgets).reduce((a, b) => a + b, 0);
        updateSimulation();
        document.dispatchEvent(new CustomEvent('allocator:rebuilt'));
    };

    const updateAvailableChannels = () => {
        const key = groupingKeySelect.value;
        const available = [...new Set(Object.values(channelModelData).filter(item => item.grouping_key === key).map(item => item.channel))];
        channelSelectDropdown.innerHTML = available.map(ch => `<label class="item"><input type="checkbox" value="${ch}" checked> ${ch}</label>`).join('');
        selectedChannels = [...available];
        channelSelectDisplay.textContent = selectedChannels.length > 1 ? `${selectedChannels.length} channels selected` : selectedChannels[0] || 'Select channels...';
    };

    const uniqueKeys = [...new Set([...Object.values(channelModelData).map(i => i.grouping_key), ...seasonalityDataJSON.map(i => i.grouping_key)])].sort();
    groupingKeySelect.innerHTML = uniqueKeys.map(k => `<option value="${k}">${k}</option>`).join('');
    
    const today = new Date(), currentYear = today.getFullYear();
    startDateInput.value = `${currentYear}-04-01`; endDateInput.value = `${currentYear}-04-30`;
    
    updateAvailableChannels(); buildSimulator();

    [startDateInput, endDateInput].forEach(el => el.addEventListener('change', buildSimulator));
    groupingKeySelect.addEventListener('change', () => { updateAvailableChannels(); buildSimulator(); });
    channelSelectDisplay.addEventListener('click', () => channelSelectContainer.classList.toggle('open'));
    document.addEventListener('click', e => { if (!channelSelectContainer.contains(e.target)) channelSelectContainer.classList.remove('open'); });
    channelSelectDropdown.addEventListener('change', e => {
        if (e.target.type === 'checkbox') {
            selectedChannels = [...channelSelectDropdown.querySelectorAll('input:checked')].map(el => el.value);
            channelSelectDisplay.textContent = selectedChannels.length > 1 ? `${selectedChannels.length} channels selected` : selectedChannels[0] || 'Select channels...';
            buildSimulator();
        }
    });

    document.getElementById('optimizeBtn').addEventListener('click', async () => {
        const revenueTarget = parseFloat(document.getElementById('revenueTarget').value.replace(/[^0-9.]/g, ''));
        const constraintValue = document.getElementById('budgetConstraint').value;
        const budgetConstraint = constraintValue ? parseFloat(constraintValue.replace(/[^0-9.]/g, '')) : null;
        if (selectedChannels.length === 0 || isNaN(revenueTarget) || revenueTarget <= 0) return alert("Please select channels and a valid revenue target.");
        const btn = document.getElementById('optimizeBtn'), progressContainer = document.getElementById('optimizer-progress'), progressBar = document.getElementById('progress-bar'), progressText = document.getElementById('progress-text');
        btn.disabled = true; btn.textContent = 'Optimising...'; progressContainer.style.display = 'block';
        try {
            const filteredChannelData = selectedChannels.reduce((acc, ch) => { if (channelModelData[ch]) acc[ch] = channelModelData[ch]; return acc; }, {});
            const optimalBudgets = await findOptimalBudgets({ channelData: filteredChannelData, revenueTarget, budgetConstraint, initialBudgets, numberOfDays: calculateDays(startDateInput.value, endDateInput.value), startDate: startDateInput.value, endDate: endDateInput.value, groupingKey: groupingKeySelect.value, progressCallback: ({ iteration, totalIterations, loss }) => { requestAnimationFrame(() => { progressBar.style.width = `${(iteration / totalIterations) * 100}%`; progressText.textContent = `Optimising... (${loss})`; }); } });
            optimalSpendByChannel = optimalBudgets;
            document.dispatchEvent(new CustomEvent('optimizer:result', { detail: { optimalByChannel: optimalBudgets } }));
            Object.entries(optimalBudgets).forEach(([ch, val]) => {
                currentBudgets[ch] = val;
                const safeId = ch.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                const slider = document.getElementById(`${safeId}-slider`), valueDisplay = document.getElementById(`${safeId}-value`);
                if (slider) { if (val > slider.max) slider.max = val * 1.2; slider.value = val; valueDisplay.textContent = `$${val.toLocaleString()}`; if (warningCheckers[ch]) warningCheckers[ch](); }
            });
            updateSimulation();
            progressText.textContent = `Optimization Complete!`;
        } catch (error) { console.error("Optimization failed:", error); alert("An error occurred during optimization."); progressText.textContent = `Error during optimization.`;
        } finally { btn.disabled = false; btn.textContent = 'Find Optimal Allocation'; setTimeout(() => { progressContainer.style.display = 'none'; }, 4000); }
    });

    // --- Visualization Module ---
    (() => {
        const Adapter = {
            getChannels: () => selectedChannels,
            getSpendBounds: (ch) => {
                const s = channelModelData[ch], days = calculateDays(startDateInput.value, endDateInput.value);
                const mu = s.avg_spend, sd = s.spend_std_dev, maxDaily = s.max_daily_spend;
                const lower = Math.max(0, mu - 1 * sd) * days;
                const upper = Math.min(mu + 2.5 * sd, Number.isFinite(maxDaily) ? maxDaily : Infinity) * days;
                return { lower: Math.max(0, lower), upper: Math.max(lower + 1, upper) };
            },
            getCurrentSpend: (ch) => currentBudgets[ch],
            getOptimalSpend: (ch) => optimalSpendByChannel ? optimalSpendByChannel[ch] : null,
            evaluateChannelRevenue: (ch, spend) => evaluateSingleChannelRevenue(ch, spend)
        };
        const placeholder = document.getElementById('tensor-visualization-placeholder');
        if (placeholder) placeholder.outerHTML = `<div id="tensor-viz" class="viz-block"><div class="viz-toolbar"><label for="viz-channel">Channel:</label><select id="viz-channel"></select><span id="viz-efficiency" aria-live="polite"></span><span class="info-helper"><span class="info-icon">?</span><span class="info-tooltip">This shows the marginal ROI, or how much additional revenue you can expect for the next dollar spent at the current and optimal points. Higher is better.</span></span></div><div id="viz-canvas-wrap"><canvas id="viz-canvas"></canvas></div></div>`;
        const root = document.querySelector('#tensor-viz'), sel = root.querySelector('#viz-channel'), eff = root.querySelector('#viz-efficiency'), cvs = root.querySelector('#viz-canvas');
        if (!window.Chart || !root) return;
        const chart = new Chart(cvs, { type: 'line', data: { datasets: [ { label: 'Revenue Curve', data: [], borderWidth: 3, pointRadius: 0, tension: 0.2 }, { label: 'Current', data: [], pointRadius: 5, pointStyle: 'circle', showLine: false }, { label: 'Optimal', data: [], pointRadius: 6, pointStyle: 'triangle', showLine: false } ] }, options: { parsing: false, animation: false, responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', title: { display: true, text: 'Spend' } }, y: { type: 'linear', title: { display: true, text: 'Projected Holistic Revenue' } } }, plugins: { legend: { display: false } } } });
        const updateAll = () => {
            sel.innerHTML = Adapter.getChannels().map(c => `<option value="${c}">${c}</option>`).join('');
            const ch = sel.value; if (!ch) return;
            const bounds = Adapter.getSpendBounds(ch);
            const xs = Array.from({ length: 120 }, (_, i) => bounds.lower + i * (bounds.upper - bounds.lower) / 119);
            chart.data.datasets[0].data = xs.map(x => ({ x, y: Adapter.evaluateChannelRevenue(ch, x) }));
            const currentX = Adapter.getCurrentSpend(ch), optimalX = Adapter.getOptimalSpend(ch);
            chart.data.datasets[1].data = currentX != null ? [{ x: currentX, y: Adapter.evaluateChannelRevenue(ch, currentX) }] : [];
            chart.data.datasets[2].data = optimalX != null ? [{ x: optimalX, y: Adapter.evaluateChannelRevenue(ch, optimalX) }] : [];
            const slope = (s) => { const d = (bounds.upper - bounds.lower) * 0.005; return (Adapter.evaluateChannelRevenue(ch, s + d) - Adapter.evaluateChannelRevenue(ch, s - d)) / (2 * d); };
            eff.innerHTML = `ΔRev/ΔSpend &mdash; <b>Current:</b> ${slope(currentX)?.toFixed(2) ?? '—'} &middot; <b>Optimal:</b> ${slope(optimalX)?.toFixed(2) ?? '—'}`;
            chart.update('none');
        };
        sel.addEventListener('change', updateAll);
        document.addEventListener('input', e => { if (e.target.type === 'range') updateAll(); });
        document.addEventListener('optimizer:result', updateAll);
        document.addEventListener('allocator:rebuilt', () => setTimeout(updateAll, 0));
        updateAll();
    })();
}



        // --- SHAPLEY PAGE ---
        function initializeShapleyPage() {
            const shapleyDrillDownData = { 'Paid Search': { drilldown: [ { label: 'Non-Brand Campaign', value: 1800000 }, { label: 'Brand Campaign', value: 1400000 }, { label: 'Shopping Campaign', value: 1000000 }, { label: 'Display Retargeting', value: 500000 } ], insight: `<h3>AI-Powered Insights</h3><p><strong>Non-Brand Search</strong> is the single largest contributor... a strong synergy.</p>` }, 'Paid Social': { drilldown: [ { label: 'Meta - Prospecting', value: 1200000 }, { label: 'Meta - Retargeting', value: 850000 }, { label: 'TikTok - Awareness', value: 500000 }, { 'label': 'Pinterest - Consideration', value: 250000 } ], insight: `<h3>AI-Powered Insights</h3><p><strong>Meta Prospecting</strong> is the key driver... lowest relative contribution.</p>` }, 'TV': { drilldown: [ { label: 'Primetime Broadcast', value: 900000 }, { label: 'Cable Sports', value: 450000 }, { label: 'Daytime News', value: 150000 } ], insight: `<h3>AI-Powered Insights</h3><p><strong>Primetime Broadcast</strong> delivers the vast majority... budget reallocation.</p>` } };
            const drilldownSelector = document.getElementById('drilldown-channel-selector');
            const drilldownContainer = document.getElementById('shapley-drilldown-container');
            const insightCard = document.getElementById('shapley-insight-card');
            const updateShapleyDrillDown = (channelName) => {
                const channelData = shapleyDrillDownData[channelName];
                if (!channelData || !drilldownContainer || !insightCard) return;
                drilldownContainer.innerHTML = '';
                channelData.drilldown.forEach(item => { drilldownContainer.innerHTML += `<div class="drilldown-text-item"><div class="label">${item.label}</div><div class="value">+${formatCurrency(item.value)}</div></div>`; });
                insightCard.innerHTML = channelData.insight;
            };
            if (drilldownSelector) {
                drilldownSelector.addEventListener('change', (event) => updateShapleyDrillDown(event.target.value));
                updateShapleyDrillDown(drilldownSelector.value);
            }
        }

        // --- ALL OTHER PAGES ---
        // These functions are copied directly from the previous version as they are already well-encapsulated.
        function initializeGranularReportingPage() {
            const groupByControls = document.getElementById('groupBy-controls');
            const chartCanvas = document.getElementById('performance-breakdown-chart');
            const tableBody = document.getElementById('performance-table-body');
            const tableGroupHeader = document.getElementById('table-group-header');
            if (!groupByControls || !chartCanvas || !tableBody || !tableGroupHeader) return;
            const performanceData = [ { channel: 'Paid Search', campaign: 'Brand Q2 Promo', targeting: 'Brand Keywords', spend: 50000, revenue: 310000, impressions: 150000, clicks: 8200, video_views: null }, { channel: 'Paid Search', campaign: 'Non-Brand: Solutions', targeting: 'High-Intent Keywords', spend: 95000, revenue: 520000, impressions: 850000, clicks: 19500, video_views: null }, { channel: 'Paid Social', campaign: 'Summer Sale Video Ads', targeting: 'Lookalike Audience', spend: 65000, revenue: 350000, impressions: 2200000, clicks: 25000, video_views: 750000 }, { channel: 'Paid Social', campaign: 'Summer Sale Retargeting', targeting: 'Website Visitors (30d)', spend: 30000, revenue: 250000, impressions: 950000, clicks: 35000, video_views: 210000 }, { channel: 'Paid Social', campaign: 'Lead Gen Carousel', targeting: 'Interest: B2B Software', spend: 40000, revenue: 210000, impressions: 1800000, clicks: 15000, video_views: null }, { channel: 'TV', campaign: 'National Brand Spot', targeting: 'Primetime', spend: 400000, revenue: 750000, impressions: null, clicks: null, video_views: null }, { channel: 'TV', campaign: 'Regional Sports Net', targeting: 'Sports Fans', spend: 150000, revenue: 220000, impressions: null, clicks: null, video_views: null }, { channel: 'Sponsorships', campaign: 'Tech Podcast Ads', targeting: 'Podcast Listeners', spend: 25000, revenue: 95000, impressions: null, clicks: null, video_views: null } ];
            let currentGroupBy = 'channel';
            const renderPerformanceData = (groupBy) => { const grouped = performanceData.reduce((acc, item) => { const key = item[groupBy]; if (!acc[key]) { acc[key] = { spend: 0, revenue: 0, impressions: 0, clicks: 0, video_views: 0 }; } acc[key].spend += item.spend; acc[key].revenue += item.revenue; acc[key].impressions += item.impressions || 0; acc[key].clicks += item.clicks || 0; acc[key].video_views += item.video_views || 0; return acc; }, {}); const processedData = Object.entries(grouped).map(([name, values]) => ({ name, ...values, roi: values.spend > 0 ? values.revenue / values.spend : 0 })).sort((a, b) => b.revenue - a.revenue); renderChart(processedData); renderTable(processedData); tableGroupHeader.textContent = groupBy.charAt(0).toUpperCase() + groupBy.slice(1); };

            const renderChart = (data) => {
                if (window.atlasCharts.breakdown) {
                    window.atlasCharts.breakdown.destroy();
                }
                const colors = getChartColors(); 
                const ctx = chartCanvas.getContext('2d'); 
                window.atlasCharts.breakdown = new Chart(ctx, { 
                    type: 'bar', 
                    data: { 
                        labels: data.map(d => d.name), 
                        datasets: [{ label: 'Attributed Revenue', data: data.map(d => d.revenue), backgroundColor: colors.gold, borderRadius: 4 }] 
                    }, 
                    options: { 
                        indexAxis: 'y', 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            y: { ticks: { color: colors.textSecondary }, grid: { display: false } }, 
                            x: { ticks: { color: colors.textSecondary, callback: (val) => formatCurrency(val) }, grid: { color: colors.gridColor } } 
                        } 
                    } 
                }); 
            };

            const renderTable = (data) => { tableBody.innerHTML = ''; data.forEach(item => { const row = document.createElement('tr'); row.style.borderBottom = '1px solid var(--atlas-border-color)'; const formatMetric = (value) => value > 0 ? value.toLocaleString() : '—'; row.innerHTML = `<td style="padding: 15px; font-weight: 600;">${item.name}</td><td style="padding: 15px; color: var(--atlas-text-secondary);">${formatCurrency(item.spend)}</td><td style="padding: 15px;">${formatCurrency(item.revenue)}</td><td style="padding: 15px; color: var(--atlas-text-secondary);">${formatMetric(item.impressions)}</td><td style="padding: 15px; color: var(--atlas-text-secondary);">${formatMetric(item.clicks)}</td><td style="padding: 15px; color: var(--atlas-text-secondary);">${formatMetric(item.video_views)}</td><td style="padding: 15px; font-weight: 700;">${item.roi.toFixed(2)}x</td>`; tableBody.appendChild(row); }); };
            groupByControls.addEventListener('click', (e) => { const button = e.target.closest('.control-btn'); if (!button || button.classList.contains('active')) return; currentGroupBy = button.dataset.group; groupByControls.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); renderPerformanceData(currentGroupBy); });
            renderPerformanceData(currentGroupBy);
        }
            function initializeAnomalyRadarPage() {
        // 1. DOM Element References
        const anomalyListView = document.getElementById('anomaly-list-view');
        const anomalyDetailView = document.getElementById('anomaly-detail-view');
        const anomalyListContainer = document.getElementById('anomaly-list-container');
        const backToListBtn = document.getElementById('back-to-list-btn');

        // Detail View Elements
        const rootCauseTreeContainer = document.getElementById('root-cause-tree');
        const forecastValueEl = document.getElementById('impact-forecast-value');
        const actualValueEl = document.getElementById('impact-actual-value');
        const deltaValueEl = document.getElementById('impact-delta-value');
        const impactChartCanvas = document.getElementById('impact-chart');
        const recommendationContainer = document.getElementById('impact-recommendation');

        // 2. Sample Data
        const anomaliesData = [
            {
                id: 1,
                date: 'July 15, 2024',
                metric: 'Revenue',
                type: 'Drop',
                deviation: -25.2,
                status: 'New',
                analysis: {
                    rootCause: {
                        name: 'Revenue Drop (-$126k)',
                        children: [{
                            name: 'Paid Social (-$110k)',
                            children: [{
                                name: 'Summer Campaign (-$95k)',
                                children: [{
                                    name: 'Creative "Beach Fun" Fatigued',
                                    children: []
                                }]
                            }]
                        }]
                    },
                    impact: {
                        forecasted: 500000,
                        actual: 374000,
                        chartLabels: ['Jul 13', 'Jul 14', 'Jul 15', 'Jul 16', 'Jul 17'],
                        forecastData: [510000, 495000, 500000, 505000, 490000],
                        actualData: [512000, 490000, 374000, 380000, 395000],
                    },
                    recommendation: {
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/></svg>`,
                        title: 'Pause "Beach Fun" Creative',
                        description: 'This creative shows high frequency and a sharp drop in CTR. Replace it with a new creative from the asset library to recover performance.'
                    }
                }
            },
            {
                id: 2,
                date: 'July 12, 2024',
                metric: 'Sign-ups',
                type: 'Spike',
                deviation: 42.1,
                status: 'New',
                analysis: {
                    rootCause: {
                        name: 'Sign-up Spike (+421)',
                        children: [{
                            name: 'Organic Search (+350)',
                            children: [{
                                name: 'Blog Post "Future of AI" (+310)',
                                children: [{
                                    name: 'Referral from TechCrunch',
                                    children: []
                                }]
                            }]
                        }]
                    },
                    impact: {
                        forecasted: 1000,
                        actual: 1421,
                        chartLabels: ['Jul 10', 'Jul 11', 'Jul 12', 'Jul 13', 'Jul 14'],
                        forecastData: [950, 1010, 1000, 980, 1020],
                        actualData: [960, 1005, 1421, 1350, 1280],
                    },
                    recommendation: {
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>`,
                        title: 'Amplify Organic Win',
                        description: 'Promote the successful blog post via Paid Social and email newsletters to capitalize on its proven appeal and maximise lead generation.'
                    }
                }
            }
        ];

        // 3. Rendering Functions
        const formatCurrency = (num) => num.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });

        const renderAnomalyList = () => {
            if (!anomalyListContainer) return; // <-- Add guard clause
            anomalyListContainer.innerHTML = '';
            anomaliesData.forEach(item => {
                const isPositive = item.type === 'Spike';
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--atlas-border-color)';
                row.innerHTML = `
                    <td style="padding: 15px; color: var(--atlas-text-secondary);">${item.date}</td>
                    <td style="padding: 15px; font-weight: 600;">${item.metric}</td>
                    <td style="padding: 15px;"><span class="change ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${item.deviation}%</span></td>
                    <td style="padding: 15px; color: var(--atlas-text-secondary);">${item.status}</td>
                    <td style="padding: 15px; text-align: right;"><button class="investigate-btn" data-id="${item.id}">Investigate</button></td>
                `;
                anomalyListContainer.appendChild(row);
            });
        };
        
        const buildTreeHtml = (node) => {
            let html = `<li><span>${node.name}</span>`;
            if (node.children && node.children.length > 0) {
                html += '<ul>';
                node.children.forEach(child => {
                    html += buildTreeHtml(child);
                });
                html += '</ul>';
            }
            html += '</li>';
            return html;
        };

        const displayAnomalyDetails = (anomalyId) => {
            const anomaly = anomaliesData.find(a => a.id === anomalyId);
            if (!anomaly) return;

            rootCauseTreeContainer.innerHTML = `<style>
                .css-tree ul { position: relative; padding: 0 0 0 20px; margin: 0; list-style-type: none; }
                .css-tree li { position: relative; padding: 5px 0 5px 20px; }
                .css-tree li::before, .css-tree li::after { content: ''; position: absolute; left: 0; }
                .css-tree li::before { border-top: 1px solid var(--atlas-border-color); width: 20px; top: 16px; height: 0; }
                .css-tree li::after { border-left: 1px solid var(--atlas-border-color); height: 100%; width: 0px; top: -5px; }
                .css-tree ul > li:last-child::after { height: 21px; }
                .css-tree li span { display: inline-block; padding: 5px 10px; border-radius: 4px; background: var(--atlas-bg-primary); border: 1px solid var(--atlas-border-color); font-weight: 600; }
            </style><ul>${buildTreeHtml(anomaly.analysis.rootCause)}</ul>`;

            const impactData = anomaly.analysis.impact;
            const delta = impactData.actual - impactData.forecasted;
            const isPositive = delta >= 0;
            const isCurrency = anomaly.metric === 'Revenue';

            forecastValueEl.textContent = isCurrency ? formatCurrency(impactData.forecasted) : impactData.forecasted.toLocaleString();
            actualValueEl.textContent = isCurrency ? formatCurrency(impactData.actual) : impactData.actual.toLocaleString();
            deltaValueEl.textContent = isCurrency ? formatCurrency(delta) : delta.toLocaleString();
            deltaValueEl.parentElement.querySelector('.value').className = `value ${isPositive ? 'positive' : 'negative'}`;

            const colors = { gold: getComputedStyle(document.body).getPropertyValue('--atlas-gold'), textSecondary: getComputedStyle(document.body).getPropertyValue('--atlas-text-secondary'), gridColor: getComputedStyle(document.body).getPropertyValue('--atlas-border-color') };
            if (window.atlasCharts.impact) window.atlasCharts.impact.destroy();
            window.atlasCharts.impact = new Chart(impactChartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: impactData.chartLabels,
                    datasets: [
                        { label: 'Forecast', data: impactData.forecastData, borderColor: colors.textSecondary, borderDash: [5, 5], tension: 0.1, pointRadius: 0 },
                        { label: 'Actual', data: impactData.actualData, borderColor: colors.gold, tension: 0.1, pointRadius: 2 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, align: 'end', labels: { color: colors.textSecondary } } }, scales: { y: { ticks: { display: false }, grid: { display: false } }, x: { ticks: { color: colors.textSecondary }, grid: { display: false } } } }
            });

            const rec = anomaly.analysis.recommendation;
            recommendationContainer.innerHTML = `<div class="recommendation-card"><div class="icon">${rec.icon}</div><div><h3>${rec.title}</h3><p>${rec.description}</p></div></div>`;
            
            anomalyListView.style.display = 'none';
            anomalyDetailView.style.display = 'block';
        };

        const closeDetailView = () => {
            anomalyListView.style.display = 'block';
            anomalyDetailView.style.display = 'none';
        };

        // 4. Event Listeners (with guard clauses)
        if (anomalyListContainer) {
            anomalyListContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.investigate-btn');
                if (button) {
                    const id = parseInt(button.dataset.id, 10);
                    displayAnomalyDetails(id);
                }
            });
        }

        if (backToListBtn) {
            backToListBtn.addEventListener('click', closeDetailView);
        }

        // 5. Initial Render
        renderAnomalyList();
    }
  
        function initializeIncrementalityPage() {
    // 1. --- ROBUST ELEMENT SELECTION ---
    const pageContainer      = document.getElementById('page-incrementality');
    if (!pageContainer) return;

    const chartArea          = pageContainer.querySelector('#incrementality-chart-area');
    const yAxisContainer     = pageContainer.querySelector('.chart-y-axis');
    const totalBaselineEl    = pageContainer.querySelector('#total-baseline-value');
    const totalIncrementalEl = pageContainer.querySelector('#total-incremental-value');
    const overallLiftEl      = pageContainer.querySelector('#overall-lift-value');
    const ratioValueEl       = pageContainer.querySelector('#incrementality-ratio-value');

    if (!chartArea || !yAxisContainer || !totalBaselineEl) {
        console.error("Incrementality Page: Missing DOM elements.");
        return;
    }

    // 2. --- SAMPLE DATA ---
    const sampleData = [
        { week: 9,  start: 'Mar 2, 2025',  baseline:    0, incremental:  888690 },
        { week: 10, start: 'Mar 3, 2025',  baseline: 5600000, incremental:  961620 },
        { week: 11, start: 'Mar 10, 2025', baseline: 5700000, incremental: 1050000 },
        { week: 12, start: 'Mar 17, 2025', baseline: 6800000, incremental: 1420000 },
        { week: 13, start: 'Mar 24, 2025', baseline: 6600000, incremental: 1380000 },
        { week: 14, start: 'Mar 31, 2025', baseline: 6400000, incremental: 1320000 },
        { week: 15, start: 'Apr 7, 2025',  baseline: 3100000, incremental:  764460 },
        { week: 16, start: 'Apr 14, 2025', baseline: 4800000, incremental: 1170000 },
        { week: 17, start: 'Apr 21, 2025', baseline: 6800000, incremental: 1640000 },
        { week: 18, start: 'Apr 28, 2025', baseline: 5900000, incremental: 1660000 },
    ];

    // 3. --- HELPERS ---
    const formatCurrency = num => {
        if (!num && num !== 0) return '$0';
        if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
        if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
        return `$${num}`;
    };

    const getWeekDateRange = startDateStr => {
        const start = new Date(startDateStr);
        const end   = new Date(start.getTime() + 6 * 24*60*60*1000);
        const sFmt  = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const eFmt  = end.toLocaleDateString('en-US',   { month: 'short', day: 'numeric', year: 'numeric' });
        return `${sFmt} to ${eFmt}`;
    };

    // 4. --- RENDER FUNCTION ---
    function renderChart() {
        // Clear previous
        yAxisContainer.innerHTML = '';
        chartArea.innerHTML     = '';

        // Y-axis ticks
        const maxTotal = Math.max(...sampleData.map(d => d.baseline + d.incremental));
        const steps    = 5;
        for (let i = 0; i <= steps; i++) {
            const val     = maxTotal * (steps - i) / steps;
            const tickDiv = document.createElement('div');
            tickDiv.textContent = formatCurrency(val);
            tickDiv.style.cssText = `
                color: var(--atlas-text-secondary);
                font-size: 12px;
            `;
            yAxisContainer.appendChild(tickDiv);
        }

        // Columns + KPI totals
        let totalBaseline = 0, totalIncremental = 0;

        sampleData.forEach(data => {
            const weekTotal = data.baseline + data.incremental;
            totalBaseline   += data.baseline;
            totalIncremental+= data.incremental;

            const totalHeightPercent       = (weekTotal / maxTotal) * 100;
            const baselinePortionPercent   = weekTotal > 0
                ? (data.baseline   / weekTotal) * 100
                : 0;
            const incrementalPortionPercent= weekTotal > 0
                ? (data.incremental/ weekTotal) * 100
                : 0;

            // Compute label positions
            const baselineMid    = baselinePortionPercent / 2;
            const incrementalMid = baselinePortionPercent + (incrementalPortionPercent / 2);

            const baselineLabel = data.baseline > 0
                ? `<div style="
                     position:absolute;
                     bottom:${baselineMid}%;
                     transform:translateY(50%);
                     font-weight:600;
                     font-size:13px;
                   ">${formatCurrency(data.baseline)}</div>`
                : '';

            const incrementalLabel = data.incremental > 0
                ? `<div style="
                     position:absolute;
                     bottom:${incrementalMid}%;
                     transform:translateY(50%);
                     font-weight:600;
                     font-size:13px;
                   ">${formatCurrency(data.incremental)}</div>`
                : '';

            // Column wrapper
            const column = document.createElement('div');
            column.style.cssText = `
                position: relative;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: center;
                max-width: 80px;
                height: 100%;
            `;

            const dateLabel = data.week === 9
                ? sampleData[0].start
                : getWeekDateRange(data.start);

            column.innerHTML = `
                ${incrementalLabel}
                ${baselineLabel}

                <div style="
                  display:flex;
                  flex-direction:column;
                  width:100%;
                  height:${totalHeightPercent}%;
                  border-radius:4px 4px 0 0;
                  overflow:hidden;
                ">
                  <!-- top: Incremental (gold) -->
                  <div style="
                    height:${incrementalPortionPercent}%;
                    background:var(--atlas-accent-color);
                  "></div>
                  <!-- bottom: Baseline (grey) -->
                  <div style="
                    height:${baselinePortionPercent}%;
                    background:var(--atlas-gray-600);
                  "></div>
                </div>

                <div style="
                  text-align:center;
                  font-size:12px;
                  color:var(--atlas-text-secondary);
                  padding-top:10px;
                  line-height:1.4;
                ">
                  ${dateLabel}<br>(Week ${data.week})
                </div>
            `;
            chartArea.appendChild(column);
        });

        // Update KPIs
        const ratio = totalBaseline > 0
            ? (totalIncremental / totalBaseline) * 100
            : 0;

        totalBaselineEl.textContent    = formatCurrency(totalBaseline);
        totalIncrementalEl.textContent = formatCurrency(totalIncremental);
        overallLiftEl.textContent      = `${ratio.toFixed(2)}%`;
        ratioValueEl.textContent       = `${ratio.toFixed(2)}%`;
    }

    // 5. --- INITIAL RENDER ---
    renderChart();
	}
	
        function initializeNextBestMovePage () {
  /* ---------- 1. DOM ELEMENT REFERENCES ---------- */
  const page = document.getElementById('page-next-best-move');
  if (!page) return;                                 // Bail if page not present

  // Scoped element look-ups
  const els = {
    gameStateStrip:        page.querySelector('#game-state-strip'),
    totalUtilityScore:     page.querySelector('#total-utility-score'),
    recommendationTitle:   page.querySelector('#recommendation-title'),
    recLift:               page.querySelector('#rec-lift'),
    recRoas:               page.querySelector('#rec-roas'),
    recConfidence:         page.querySelector('#rec-confidence'),
    whyBtn:                page.querySelector('#why-btn'),
    moveExplorerDrawer:    page.querySelector('#move-explorer-drawer'),
    altMovesList:          page.querySelector('#alternative-moves-list'),
    driverChipsContainer:  page.querySelector('#causal-driver-chips'),
    sandbox:               page.querySelector('#simulation-sandbox'),
    humanVsEngineScore:    page.querySelector('#human-vs-engine-score'),
    commitBtn:             page.querySelector('#commit-move-btn'),
    riskRadarCanvas:       page.querySelector('#risk-radar-chart'),
    lookAheadCanvas:       page.querySelector('#look-ahead-chart'),
  };

  /* ---------- 2. HELPER: THEME COLOURS ---------- */
  const getChartColors = () => {
    const cs = getComputedStyle(document.body);
    return {
      gold:         cs.getPropertyValue('--atlas-gold'),
      textSecondary:cs.getPropertyValue('--atlas-text-secondary'),
      grid:         cs.getPropertyValue('--atlas-border-color'),
    };
  };

  /* ---------- 3. SAMPLE DATA MODEL ---------- */
  const state = {
    channels: {
      YouTube: { plan: 150000, actual: 165000, mROAS: 5.2, reach: 75, ceiling: 300000 },
      Meta:    { plan: 250000, actual: 235000, mROAS: 2.8, reach: 92, ceiling: 400000 },
      TikTok:  { plan:  80000, actual:  80000, mROAS: 3.5, reach: 60, ceiling: 200000 },
      TV:      { plan: 500000, actual: 500000, mROAS: 1.9, reach: 88, ceiling: 750000 }
    },
    engineMove : { from: 'Meta', to: 'YouTube', amount: 15000 },
    drivers    : ['YouTube creative resonance', 'Meta audience fatigue', 'Low auction overlap'],
    altMoves   : [
      { move: 'TV → YouTube +$20k',  utility: '+0.09', pruned: false, reason: '' },
      { move: 'TikTok → YouTube +$10k', utility: '+0.07', pruned: false, reason: '' },
      { move: 'Meta → TV +$30k',    utility: '-0.02', pruned: true,  reason: 'Marginal ROAS < Destination ROAS' }
    ],
    risk     : { 'Data Freshness': 90, 'Model Drift': 85, Seasonality: 70, Competition: 60 },
    forecast : [85.2, 85.9, 86.3, 86.5, 86.6],
  };

  /* ---------- 4. UTILS ---------- */
  const fmtCurrency  = v => `$${(v/1e3).toFixed(0)}k`;
  const calcUtility  = obj => Object.values(obj).reduce((sum,c) => sum + c.actual * c.mROAS, 0);
  const engineUtility = calcUtility(state.channels);

  /* ---------- 5. RENDERERS ---------- */
  function renderGameState () {
    const wrap = els.gameStateStrip;
    wrap.innerHTML = '';

    Object.entries(state.channels).forEach(([name,data]) => {
      const delta      = data.actual - data.plan;
      const deltaClass = delta>0 ? 'positive' : delta<0 ? 'negative' : '';
      const deltaLabel = delta === 0
        ? 'On Plan'
        : `${fmtCurrency(Math.abs(delta))} ${delta>0 ? 'Over' : 'Under'}`;

      wrap.insertAdjacentHTML('beforeend', `
        <div class="kpi-card">
          <div class="label">${name}</div>
          <div class="value">${fmtCurrency(data.actual)}</div>
          <div class="change ${deltaClass}">${deltaLabel}</div>
        </div>`);
    });
  }

  function renderSandbox () {
    const box = els.sandbox;
    box.innerHTML = '';

    Object.entries(state.channels).forEach(([name,data]) => {
      const safeId = name.replace(/\s+/g,'-').toLowerCase();
      const row = document.createElement('div');
      row.className = 'simulator-grid';
      row.style.gridTemplateColumns = '100px 1fr 80px';

      row.innerHTML = `
        <label for="${safeId}-rng">${name}</label>
        <input  id="${safeId}-rng" type="range"
                min="0" max="${data.ceiling}" value="${data.actual}" step="1000">
        <div   id="${safeId}-val" class="budget-value">${fmtCurrency(data.actual)}</div>`;

      // slider listener
      row.querySelector(`#${safeId}-rng`).addEventListener('input', e => {
        const v = +e.target.value;
        state.channels[name].actual = v;
        row.querySelector(`#${safeId}-val`).textContent = fmtCurrency(v);
        updateScores();
      });

      box.appendChild(row);
    });
  }

  function renderAltMoves () {
    const list = els.altMovesList;
    list.innerHTML = '';
    state.altMoves.forEach(m => {
      const tag = m.pruned
        ? `<span class="pruned-tag" title="${m.reason}">Pruned</span>`
        : `<span class="change positive">${m.utility} ΔU</span>`;

      list.insertAdjacentHTML('beforeend', `
        <div class="alt-move-item"><span>${m.move}</span>${tag}</div>`);
    });
  }

  function renderCharts () {
    window.atlasCharts ||= {};         // safety-net

    const {riskRadarCanvas:radar, lookAheadCanvas:line} = els;
    const c = getChartColors();

    // Risk radar
    if (window.atlasCharts.riskRadar) window.atlasCharts.riskRadar.destroy();
    window.atlasCharts.riskRadar = new Chart(radar, {
      type:'radar',
      data:{
        labels:  Object.keys(state.risk),
        datasets:[{
          data:Object.values(state.risk),
          label:'Risk',
          backgroundColor:`${c.gold}40`,
          borderColor:c.gold,
          borderWidth:2,
          pointBackgroundColor:c.gold,
        }]
      },
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{r:{beginAtZero:true,max:100,ticks:{display:false},
          grid:{color:c.grid},pointLabels:{color:c.textSecondary}}}}
    });

    // Look-ahead sparkline
    if (window.atlasCharts.lookAhead) window.atlasCharts.lookAhead.destroy();
    window.atlasCharts.lookAhead = new Chart(line, {
      type:'line',
      data:{labels:['t','t+1','t+2','t+3','t+4'],
        datasets:[{data:state.forecast,borderColor:c.gold,borderWidth:3,tension:.4,pointRadius:0}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{y:{ticks:{display:false},grid:{display:false}},
                x:{ticks:{color:c.textSecondary},grid:{display:false}}}}
    });
  }

  /* ---------- 6. SCORE UPDATER ---------- */
  function updateScores () {
    const utilHuman   = calcUtility(state.channels);
    const deltaBps    = ((utilHuman - engineUtility) / engineUtility) * 1e4;
    els.totalUtilityScore.textContent = (utilHuman/1e6).toFixed(2);

    const hud = els.humanVsEngineScore;
    if (Math.abs(deltaBps) < 1) {
      hud.textContent = 'Engine is optimal';
      hud.className   = 'change';
    } else if (deltaBps > 0) {
      hud.textContent = `Atlas Engine +${deltaBps.toFixed(0)} bps`;
      hud.className   = 'change positive';
    } else {
      hud.textContent = `Manual +${Math.abs(deltaBps).toFixed(0)} bps`;
      hud.className   = 'change negative';
    }
  }

  /* ---------- 7. EVENT LISTENERS ---------- */
  els.whyBtn.addEventListener('click', () => {
    const shown = els.moveExplorerDrawer.style.display !== 'none';
    els.moveExplorerDrawer.style.display = shown ? 'none' : 'block';
    els.whyBtn.textContent = shown ? 'Explore Other Moves' : 'Hide Alternatives';
  });

  els.commitBtn.addEventListener('click', () => {
    const btn = els.commitBtn;
    btn.disabled = true;
    btn.textContent = 'Committing…';
    setTimeout(() => {
      btn.disabled = false;
      btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;margin-right:8px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
        </svg>
        Commit & Schedule Move`;
    }, 2000);
  });

  /* ---------- 8. FIRST PAINT ---------- */
  renderGameState();
  renderSandbox();
  renderAltMoves();
  renderCharts();
  updateScores();

  els.driverChipsContainer.innerHTML =
    state.drivers.map(d => `<span class="nbm-chip">${d}</span>`).join('');
}	
	
	
        function initializeFunnelPage() {
    // 1. DOM Element References
    const dataSourceSelect = document.getElementById('funnel-data-source');

    const kpiElements = {
        awareness: {
            shapley: document.getElementById('awareness-shapley'),
            investment: document.getElementById('awareness-investment'),
            convValue: document.getElementById('awareness-conv-value'),
            roas: document.getElementById('awareness-roas')
        },
        consideration: {
            shapley: document.getElementById('consideration-shapley'),
            investment: document.getElementById('consideration-investment'),
            convValue: document.getElementById('consideration-conv-value'),
            roas: document.getElementById('consideration-roas')
        },
        decision: {
            shapley: document.getElementById('decision-shapley'),
            investment: document.getElementById('decision-investment'),
            convValue: document.getElementById('decision-conv-value'),
            roas: document.getElementById('decision-roas')
        }
    };

    // 2. Sample Data
    const funnelData = {
        overall: {
            awareness: { shapley: 4.42, investment: 167004, convValue: 495548, roas: 2.97 },
            consideration: { shapley: 4.73, investment: 225877, convValue: 703355, roas: 3.11 },
            decision: { shapley: 4.69, investment: 161496, convValue: 710366, roas: 4.40 }
        },
        q2_social: {
            awareness: { shapley: 5.12, investment: 82000, convValue: 215300, roas: 2.63 },
            consideration: { shapley: 4.95, investment: 110500, convValue: 341800, roas: 3.09 },
            decision: { shapley: 4.21, investment: 55000, convValue: 290500, roas: 5.28 }
        },
        q3_search: {
            awareness: { shapley: 3.98, investment: 85004, convValue: 280248, roas: 3.30 },
            consideration: { shapley: 4.51, investment: 115377, convValue: 361555, roas: 3.13 },
            decision: { shapley: 5.03, investment: 106496, convValue: 419866, roas: 3.94 }
        }
    };

    // 3. Core Function to Update UI
    const updateFunnelView = (sourceKey) => {
        const data = funnelData[sourceKey];
        if (!data) return;

        // Helper for formatting
        const formatCurrency = (num) => `$${num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

        // Update Awareness KPIs
        kpiElements.awareness.shapley.textContent = `${data.awareness.shapley.toFixed(2)}%`;
        kpiElements.awareness.investment.textContent = formatCurrency(data.awareness.investment);
        kpiElements.awareness.convValue.textContent = formatCurrency(data.awareness.convValue);
        kpiElements.awareness.roas.textContent = `$${data.awareness.roas.toFixed(2)}`;

        // Update Consideration KPIs
        kpiElements.consideration.shapley.textContent = `${data.consideration.shapley.toFixed(2)}%`;
        kpiElements.consideration.investment.textContent = formatCurrency(data.consideration.investment);
        kpiElements.consideration.convValue.textContent = formatCurrency(data.consideration.convValue);
        kpiElements.consideration.roas.textContent = `$${data.consideration.roas.toFixed(2)}`;

        // Update Decision KPIs
        kpiElements.decision.shapley.textContent = `${data.decision.shapley.toFixed(2)}%`;
        kpiElements.decision.investment.textContent = formatCurrency(data.decision.investment);
        kpiElements.decision.convValue.textContent = formatCurrency(data.decision.convValue);
        kpiElements.decision.roas.textContent = `$${data.decision.roas.toFixed(2)}`;
    };
    
    // 4. Event Listener
    if (dataSourceSelect) {
        dataSourceSelect.addEventListener('change', (event) => {
            updateFunnelView(event.target.value);
        });
    }

    // 5. Initial Render
    updateFunnelView('overall');
}	
	
	

        // ===============================================================
        // INITIAL LOAD
        // ===============================================================
        const savedTheme = localStorage.getItem('atlas-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.checked = (savedTheme === 'dark');

        const initialPageId = document.querySelector('.sidebar nav a.active')?.getAttribute('data-target').replace('page-', '') || 'command-center';
        loadPage(initialPageId);
    });
    </script>
</body>
</html>